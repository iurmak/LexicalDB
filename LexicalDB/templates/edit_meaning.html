{% extends 'base.html' %}
{% block title %}
    Редактирование значения
{% endblock %}
{% block content %}
    <div class="container mb-2">
        <div class="container row mb-2 g-2 align-items-center justify-content-start">
            <div class="col-12 col-lg-9 row g-2">
                <div class="col-12">
                    <div class="form-floating">
                        <select form="meaning" class="form-select" id="based_on" name="based_on">
                            <option value="">отсутствует</option>
                            {% for t in Templates.query.order_by(Templates.templ.asc()).all() %}
                                <option value="{{ t.templ_id }}" {% if Template_relations.query.filter_by(target_id=m.m_id, type=4).first() and t.templ_id == Template_relations.query.filter_by(target_id=m.m_id, type=4).first().templ_id %}selected{% endif %}>{{ t.templ }}</option>
                            {% endfor %}
                        </select>
                        <label for="based_on">
                            Родительский шаблон
                        </label>
                    </div>
                </div>
                <div class="col-12 mb-2">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="short_meaning" name="short_meaning" placeholder="meaning" value="{{ m.meaning }}" form="meaning">
                        <label for="short_meaning">Краткая формулировка значения</label>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-3 row align-items-center justify-content-center g-2">
                <div class="col-12 text-center">
                    Лексема: <a href="{{ url_for('edit_lexeme', lex_id=m.lex_id) }}" target="_blank"><b>{{ Forms.query.filter_by(lex_id=m.lex_id).first().form }} (ID {{ m.lex_id }})</b></a>
                </div>
                <div class="col-12 text-center mb-2">
                    <button class="btn btn-sm btn-success" type="submit" form="meaning">
                        Сохранить
                    </button>
                </div>
                <div class="col-12 text-center mb-2">
                    <button class="btn btn-sm btn-danger" type="submit" form="delete">
                        Удалить
                    </button>
                    <form name="delete" method="post" id="delete"><input class="d-none" type="text" name="delete_meaning" value="1"></form>
                </div>
            </div>
        </div>
        <form name="meaning" id="meaning" method="post">
            <div class="container row g-2 mb-2 align-items-center justify-content-start">
                <div class="col-auto">
                    <span class="form-label h5">Участники</span>
                </div>
                <div class="col-auto">
                    <button class="btn btn-sm btn-primary"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapse_participants"
                            aria-expanded="true"
                            aria-controls="collapse_participants"
                            onclick="if (this.classList.contains('collapsed')) {this.textContent = 'Показать'} else {this.textContent = 'Скрыть'};"
                            >
                        Скрыть
                    </button>
                </div>
                <div class="col-auto">
                    <button class="btn btn-sm btn-outline-success" onclick="addParticipant()" type="button">
                        <span class="text-center">Создать нового участника</span>
                    </button>
                </div>
                <div class="col-auto">
                    <select class="form-select form-select-sm" onchange="if (this.value) {addExistentParticipant(this.value)}" id="select_new">
                        <option selected value="">Создать с опорой на существующего</option>
                        {% for p in Participants.query.filter_by(type=1).all() %}
                            <option value="{{ p.participant_id }}">
                                {{ p.participant }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="collapse show container overflow-auto mb-2" style="max-height: 60vh;" id="collapse_participants">
                <div class="row row-cols-1 row-cols-lg-3 g-2" id="participants">
                    {% for p in Participant_relations.query.filter_by(target_id=m.m_id, type=4).all() %}
                        <div class="col row row-cols-1 align-items-center justify-content-center g-2 border-bottom border-1" id="existent_participant_{{ p.participant_id}}">
                            <div class="col-auto row align-items-center justify-content-center g-2">
                                <div class="col-auto">
                                    <button type="button" class="btn btn-sm btn-outline btn-outline-danger" onclick="deleteParticipant(existent_participant_{{ p.participant_id }})">
                                        Удалить
                                    </button>
                                </div>
                                <div class="col-auto">
                                    <a class="btn btn-sm btn-warning" href="{{ url_for("edit_participant", participant_id=p.participant_id) }}" target="_blank">
                                        Редактировать
                                    </a>
                                </div>
                                <div class="col-auto">
                                    <span>ID: <b>{{ p.participant_id}}</b></span>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-floating">
                                    <input type="text" class="form-control label_not_in_use" id="existent_label_{{ p.participant_id}}"
                                           name="existent_label_{{ p.participant_id}}"
                                           placeholder="Введите текст"
                                           value="{{ Participants.query.get(p.participant_id).participant }}"
                                           oninput="checkLabelAvailability(this, this.value)"
                                           disabled
                                           required
                                    >
                                    <label for="existent_label_{{ p.participant_id}}">Ярлык</label>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="existent_sr_{{ p.participant_id}}"
                                           name="existent_sr_{{ p.participant_id}}"
                                           placeholder="Введите текст"
                                           list="sr_list"
                                           value="{% if Participants.query.get(p.participant_id).sr_id %}{{ Semantic_roles.query.get(Participants.query.get(p.participant_id).sr_id).sr }}{% endif %}"
                                           oninput="suggestions('sr', existent_sr_{{ p.participant_id}}.value)"
                                           disabled
                                    >
                                    <label for="existent_sr_{{ p.participant_id}}">Семантическая роль</label>
                                </div>
                            </div>
                            <div class="col">
                                <div class="col-12 align-items-center text-center">
                                    <span style="text-decoration-line: none; font-variant: small-caps">Мереология</span>
                                </div>
                                <div class="col-12 align-items-center text-center mb-1">
                                    <a class="text-primary h5"
                                       href="javascript:;"
                                       role="button"
                                       data-bs-toggle="dropdown"
                                       data-bs-auto-close="outside"
                                       aria-expanded="false"
                                       style="text-decoration-line: none; font-size: smaller"
                                    >
                                        {% if Check.labels(p.participant_id, 'mer', tooltips=False) %}
                                            <span>{{ Check.labels(p.participant_id, 'mer', tooltips=False) }}</span>
                                        {% else %}
                                            <span>Добавить</span>
                                        {% endif %}
                                    </a>
                                    <ul class="dropdown-menu overflow-auto p-1" style="height: 200px">
                                        {% for l in Labels.query.filter_by(type=1).all() %}
                                            <li>
                                                <div class="form-check">
                                                    <input class="form-check-input"
                                                           type="checkbox"
                                                           value="{{ l.l_id }}"
                                                           id="existent_mer_{{ p.participant_id}}_{{ l.l_id }}"
                                                           name="existent_mer_{{ p.participant_id}}_{{ l.l_id }}"
                                                           {% if Participant_relations.query.filter_by(participant_id=p.participant_id, target_id=l.l_id, type=5).first() %}checked{% endif %}
                                                           disabled
                                                    >
                                                    <label class="form-check-label"
                                                           for="existent_mer_{{ p.participant_id}}_{{ l.l_id }}"
                                                           style="font-variant: small-caps"
                                                    >
                                                        {{ l.l }}
                                                    </label>
                                                </div>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            <div class="col">
                                <div class="col-12 align-items-center text-center">
                                    <span style="text-decoration-line: none; font-variant: small-caps">Таксономия</span>
                                </div>
                                <div class="col-12 align-items-center text-center mb-1">
                                    <a class="text-primary h5"
                                       href="javascript:;"
                                       role="button"
                                       data-bs-toggle="dropdown"
                                       data-bs-auto-close="outside"
                                       aria-expanded="false"
                                       style="text-decoration-line: none; font-size: smaller"
                                    >
                                        {% if Check.labels(p.participant_id, 'tax', tooltips=False) %}
                                            <span>{{ Check.labels(p.participant_id, 'tax', tooltips=False) }}</span>
                                        {% else %}
                                            <span>Добавить</span>
                                        {% endif %}
                                    </a>
                                    <ul class="dropdown-menu overflow-auto p-1" style="height: 200px">
                                        {% for l in Labels.query.filter_by(type=2).all() %}
                                            <li>
                                                <div class="form-check">
                                                    <input class="form-check-input"
                                                           type="checkbox"
                                                           value="{{ l.l_id }}"
                                                           id="existent_tax_{{ p.participant_id}}_{{ l.l_id }}"
                                                           name="existent_tax_{{ p.participant_id}}_{{ l.l_id }}"
                                                           {% if Participant_relations.query.filter_by(participant_id=p.participant_id, target_id=l.l_id, type=1).first() %}checked{% endif %}
                                                           disabled
                                                    >
                                                    <label class="form-check-label"
                                                           for="existent_tax_{{ p.participant_id}}_{{ l.l_id }}"
                                                           style="font-variant: small-caps"
                                                    >
                                                        {{ l.l }}
                                                    </label>
                                                </div>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            <div class="col">
                                <div class="col-12 align-items-center text-center">
                                    <span style="text-decoration-line: none; font-variant: small-caps">Топология</span>
                                </div>
                                <div class="col-12 align-items-center text-center mb-1">
                                    <a class="text-primary h5"
                                       href="javascript:;"
                                       role="button"
                                       data-bs-toggle="dropdown"
                                       data-bs-auto-close="outside"
                                       aria-expanded="false"
                                       style="text-decoration-line: none; font-size: smaller"
                                    >
                                        {% if Check.labels(p.participant_id, 'top', tooltips=False) %}
                                            <span>{{ Check.labels(p.participant_id, 'top', tooltips=False) }}</span>
                                        {% else %}
                                            <span>Добавить</span>
                                        {% endif %}
                                    </a>
                                    <ul class="dropdown-menu overflow-auto p-1" style="height: 200px">
                                        {% for l in Labels.query.filter_by(type=3).all() %}
                                            <li>
                                                <div class="form-check">
                                                    <input class="form-check-input"
                                                           type="checkbox"
                                                           value="{{ l.l_id }}"
                                                           id="existent_top_{{ p.participant_id}}_{{ l.l_id }}"
                                                           name="existent_top_{{ p.participant_id}}_{{ l.l_id }}"
                                                           {% if Participant_relations.query.filter_by(participant_id=p.participant_id, target_id=l.l_id, type=2).first() %}checked{% endif %}
                                                           disabled
                                                    >
                                                    <label class="form-check-label"
                                                           for="existent_top_{{ p.participant_id}}_{{ l.l_id }}"
                                                           style="font-variant: small-caps"
                                                    >
                                                        {{ l.l }}
                                                    </label>
                                                </div>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="existent_other_{{ p.participant_id}}"
                                           name="existent_other_{{ p.participant_id}}"
                                           placeholder="Введите текст"
                                           value="{{ Participants.query.get(p.participant_id).other }}"
                                           disabled
                                    >
                                    <label for="existent_other_{{ p.participant_id}}">Другое</label>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-floating">
                                    <select class="form-select" id="status_{{ p.participant_id}}" name="status_{{ p.participant_id}}" disabled>
                                        <option value="1"{% if Participants.query.get(p.participant_id).status == 1 %} selected{% endif %}>ядерный</option>
                                        <option value="2"{% if Participants.query.get(p.participant_id).status == 2 %} selected{% endif %}>периферийный</option>
                                        <option value="3"{% if Participants.query.get(p.participant_id).status == 3 %} selected{% endif %}>инкорпорированный</option>
                                    </select>
                                    <label for="status_{{ p.participant_id}}">Этот участник</label>
                                </div>
                            </div>
                            <div class="col mb-2">
                                <div>
                                    <label for="is_child_{{ p.participant_id}}" class="form-label">Родительский участник</label>
                                    <select class="form-select" size="4" id="is_child_{{ p.participant_id}}" name="is_child_{{ p.participant_id}}" disabled multiple>
                                        <option value="">отсутствует</option>
                                        {% for i in Participants.query.filter_by(type=1).all() %}
                                            <option value="{{ i.participant_id }}"{% if Participant_relations.query.filter_by(participant_id=i.participant_id, target_id=p.participant_id, type=3).first() %} selected{% endif %}>
                                                {{ i.participant }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            <div class="container row g-2 mb-2 align-items-center justify-content-start">
                <div class="col-auto">
                    <span class="form-label h5">Примеры</span>
                </div>
                <div class="col-auto">
                    <button class="btn btn-sm btn-primary"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapse_examples"
                            aria-expanded="true"
                            aria-controls="collapse_examples"
                            onclick="if (this.classList.contains('collapsed')) {this.textContent = 'Показать'} else {this.textContent = 'Скрыть'};"
                            >
                        Скрыть
                    </button>
                </div>
                <div class="col-auto">
                    <button class="btn btn-sm btn-outline-success" onclick="addExample()" type="button">
                        <span class="text-center">Новый пример</span>
                    </button>
                </div>
            </div>
            <div class="container mb-2 row align-items-center justify-content-around overflow-auto collapse show" style="max-height: 60vh;" id="collapse_examples">
                <div class="row row-cols-1 g-2" id="examples">
                    {% for e in Example_to_meaning.query.filter_by(m_id=m.m_id) %}
                        <div class="col" id="existing_example_column_{{ e.example_id }}">
                            <div class="card my-2">
                                <div class="container my-2 text-danger text-center">
                                    <span type="button" href="();" onclick="deleteExample(existing_example_column_{{ e.example_id }})">Удалить</span>
                                </div>
                                <div class="container my-2">
                                    <div class="form-floating">
                                        <textarea class="form-control overflow-auto"
                                                  id="existing_government_{{ e.example_id }}"
                                                  name="existing_government_{{ e.example_id }}"
                                                  placeholder="Пример"
                                                  style="max-height: 300px">{{ Examples.query.get(e.example_id).government }}</textarea>
                                        <label for="existing_government_{{ e.example_id }}">Формула управления</label>
                                    </div>
                                </div>
                                <div class="container mb-2">
                                    <div class="form-floating">
                                        <textarea class="form-control overflow-auto"
                                                  id="existing_example_{{ e.example_id }}"
                                                  name="existing_example_{{ e.example_id }}"
                                                  placeholder="Пример"
                                                  style="max-height: 300px">{{ Examples.query.get(e.example_id).example }}</textarea>
                                        <label for="existing_example_{{ e.example_id }}">Пример (в транскрипции)</label>
                                    </div>
                                </div>
                                <div class="container mb-2">
                                    <div class="form-floating">
                                        <textarea class="form-control overflow-auto"
                                                  id="existing_original_script_{{ e.example_id }}"
                                                  name="existing_original_script_{{ e.example_id }}"
                                                  placeholder="Пример"
                                                  style="max-height: 300px">{{ Examples.query.get(e.example_id).original_script }}</textarea>
                                        <label for="existing_original_script_{{ e.example_id }}">В графике</label>
                                    </div>
                                </div>
                                <div class="container mb-2">
                                    <div class="form-floating">
                                        <textarea class="form-control overflow-auto"
                                                  id="existing_translation_{{ e.example_id }}"
                                                  name="existing_translation_{{ e.example_id }}"
                                                  placeholder="Пример"
                                                  style="max-height: 300px">{{ Examples.query.get(e.example_id).translation }}</textarea>
                                        <label for="existing_translation_{{ e.example_id }}">Перевод</label>
                                    </div>
                                </div>
                                <div class="container mb-2">
                                    <div class="form-floating">
                                        <textarea class="form-control overflow-auto"
                                                  id="existing_source_{{ e.example_id }}"
                                                  name="existing_source_{{ e.example_id }}"
                                                  placeholder="Пример"
                                                  style="max-height: 300px">{{ Examples.query.get(e.example_id).source }}</textarea>
                                        <label for="existing_source_{{ e.example_id }}">Источник</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            <div class="container mb-2">
                <div class="row g-2 mb-2 align-items-center justify-content-start">
                    <div class="col-auto">
                        <span class="form-label h5">Структура события</span>
                    </div>
                </div>
                <div class="container mb-2">
                    <div class="row row-cols-2 mb-2">
                        <div class="col-auto">
                            <span class="form-label h6">Начальное состояние</span>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-sm btn-outline-success mb-2" onclick="addElement('Initial_state')" type="button">
                                <span class="text-center">Добавить</span>
                            </button>
                        </div>
                    </div>
                    <div class="row row-cols-1 g-2 overflow-auto border-bottom border-2 mb-2" id="Initial_state" style="max-height: 30vh;">
                        {% for i in Event_structure_relations.query.filter_by(target_id=m.m_id, type=2).join(Event_structure, Event_structure_relations.ese_id==Event_structure.ese_id).filter(Event_structure.type==1).order_by(Event_structure.rank.asc()).all() %}
                            <div class="col row mb-1 align-items-center justify-content-start g-2 p-1" id="ese_existent_I_{{ i.ese_id }}">
                                <div class="col-3 col-xxl-2 g-2 mt-0 row row-cols-1 align-items-center justify-content-center">
                                    <div class="col-auto">
                                        <span type="button" href="();" onclick="deleteESE(ese_existent_I_{{ i.ese_id }})">❌</span>
                                    </div>
                                    <div class="col-auto">
                                        <input class="form-control form-control-sm"
                                               type="number" required
                                               value="{{ Event_structure.query.get(i.ese_id).rank }}"
                                               id="rank_existent_I_{{ i.ese_id }}"
                                               name="rank_existent_I_{{ i.ese_id }}"
                                               >
                                    </div>
                                    <div class="col-auto">
                                        <select class="form-select form-select-sm" id="status_ese_existent_I_{{ i.ese_id }}" name="status_ese_existent_I_{{ i.ese_id }}">
                                            <option value="1" {% if Event_structure.query.get(i.ese_id).status == 1 %}selected{% endif %}>ассерция</option>
                                            <option value="2" {% if Event_structure.query.get(i.ese_id).status == 2 %}selected{% endif %}>пресуппозиция</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-9 col-xxl-2">
                                    <div class="form-floating">
                                        <select class="form-select" id="is_child_existent_I_{{ i.ese_id }}" name="is_child_existent_I_{{ i.ese_id }}">
                                            <option value="">текущий</option>
                                            {% for t in Templates.query.all() %}
                                                {% if t.templ_id != templ_id %}
                                                    <option value="{{ t.templ_id }}" {% if Event_structure_relations.query.filter_by(ese_id=i.ese_id, target_id=t.templ_id, type=3).first() %} selected{% endif %}>{{t.templ}}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                        <label for="is_child_existent_I_{{ i.ese_id }}">Родительский шаблон</label>
                                    </div>
                                </div>
                                <div class="col-12 col-xxl-2">
                                    <div class="form-floating">
                                        <select class="form-select" id="control_existent_I_{{ i.ese_id }}" name="control_existent_I_{{ i.ese_id }}">
                                            <option value="1" {% if Event_structure.query.get(i.ese_id).controllable == 1 %}selected{% endif %}>контролируемое</option>
                                            <option value="2" {% if Event_structure.query.get(i.ese_id).controllable == 2 %}selected{% endif %}>неконтролируемое</option>
                                            <option value="3" {% if Event_structure.query.get(i.ese_id).controllable == 3 %}selected{% endif %}>(не)контролируемое</option>
                                        </select>
                                        <label for="control_existent_I_{{ i.ese_id }}">Контролируемость</label>
                                    </div>
                                </div>
                                <div class="col-12 col-sm-12 col-xxl-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="existent_I_{{ i.ese_id }}"
                                               name="existent_I_{{ i.ese_id }}"
                                               placeholder="Введите текст"
                                               list="I_list"
                                               oninput="suggestions('I', existent_I_{{ i.ese_id }}.value)"
                                               value="{{ Event_structure.query.get(i.ese_id).ese }}"
                                        >
                                        <label for="existent_I_{{ i.ese_id }}">Введите описание</label>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="row row-cols-2 mb-2">
                        <div class="col-auto">
                            <span class="form-label h6">Начало действия</span>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-sm btn-outline-success mb-2" onclick="addElement('Beginning')" type="button">
                                <span class="text-center">Добавить</span>
                            </button>
                        </div>
                    </div>
                    <div class="row row-cols-1 g-2 overflow-auto border-bottom border-2 mb-2" id="Beginning" style="max-height: 30vh;">
                        {% for i in Event_structure_relations.query.filter_by(target_id=m.m_id, type=2).join(Event_structure, Event_structure_relations.ese_id==Event_structure.ese_id).filter(Event_structure.type==2).order_by(Event_structure.rank.asc()).all() %}
                            <div class="col row mb-1 align-items-center justify-content-start g-2 p-1" id="ese_existent_B_{{ i.ese_id }}">
                                <div class="col-3 col-xxl-2 g-2 mt-0 row row-cols-1 align-items-center justify-content-center">
                                    <div class="col-auto">
                                        <span type="button" href="();" onclick="deleteESE(ese_existent_B_{{ i.ese_id }})">❌</span>
                                    </div>
                                    <div class="col-auto">
                                        <input class="form-control form-control-sm"
                                               type="number" required
                                               value="{{ Event_structure.query.get(i.ese_id).rank }}"
                                               id="rank_existent_B_{{ i.ese_id }}"
                                               name="rank_existent_B_{{ i.ese_id }}"
                                               >
                                    </div>
                                    <div class="col-auto">
                                        <select class="form-select form-select-sm" id="status_ese_existent_B_{{ i.ese_id }}" name="status_ese_existent_B_{{ i.ese_id }}">
                                            <option value="1" {% if Event_structure.query.get(i.ese_id).status == 1 %}selected{% endif %}>ассерция</option>
                                            <option value="2" {% if Event_structure.query.get(i.ese_id).status == 2 %}selected{% endif %}>пресуппозиция</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-9 col-xxl-2">
                                    <div class="form-floating">
                                        <select class="form-select" id="is_child_existent_B_{{ i.ese_id }}" name="is_child_existent_B_{{ i.ese_id }}">
                                            <option value="">текущий</option>
                                            {% for t in Templates.query.all() %}
                                                {% if t.templ_id != templ_id %}
                                                    <option value="{{ t.templ_id }}" {% if Event_structure_relations.query.filter_by(ese_id=i.ese_id, target_id=t.templ_id, type=3).first() %} selected{% endif %}>{{t.templ}}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                        <label for="is_child_existent_B_{{ i.ese_id }}">Родительский шаблон</label>
                                    </div>
                                </div>
                                <div class="col-12 col-xxl-2">
                                    <div class="form-floating">
                                        <select class="form-select" id="control_existent_B_{{ i.ese_id }}" name="control_existent_B_{{ i.ese_id }}">
                                            <option value="1" {% if Event_structure.query.get(i.ese_id).controllable == 1 %}selected{% endif %}>контролируемое</option>
                                            <option value="2" {% if Event_structure.query.get(i.ese_id).controllable == 2 %}selected{% endif %}>неконтролируемое</option>
                                            <option value="3" {% if Event_structure.query.get(i.ese_id).controllable == 3 %}selected{% endif %}>(не)контролируемое</option>
                                        </select>
                                        <label for="control_existent_B_{{ i.ese_id }}">Контролируемость</label>
                                    </div>
                                </div>
                                <div class="col-12 col-sm-12 col-xxl-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="existent_B_{{ i.ese_id }}"
                                               name="existent_B_{{ i.ese_id }}"
                                               placeholder="Введите текст"
                                               list="B_list"
                                               oninput="suggestions('B', existent_B_{{ i.ese_id }}.value)"
                                               value="{{ Event_structure.query.get(i.ese_id).ese }}"
                                        >
                                        <label for="existent_B_{{ i.ese_id }}">Введите описание</label>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="row row-cols-2 mb-2">
                        <div class="col-auto">
                            <span class="form-label h6">Процесс</span>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-sm btn-outline-success mb-2" onclick="addElement('Process')" type="button">
                                <span class="text-center">Добавить</span>
                            </button>
                        </div>
                    </div>
                    <div class="row row-cols-1 g-2 overflow-auto border-bottom border-2 mb-2" id="Process" style="max-height: 30vh;">
                        {% for i in Event_structure_relations.query.filter_by(target_id=m.m_id, type=2).join(Event_structure, Event_structure_relations.ese_id==Event_structure.ese_id).filter(Event_structure.type==3).order_by(Event_structure.rank.asc()).all() %}
                            <div class="col row mb-1 align-items-center justify-content-start g-2 p-1" id="ese_existent_P_{{ i.ese_id }}">
                                <div class="col-3 col-xxl-2 g-2 mt-0 row row-cols-1 align-items-center justify-content-center">
                                    <div class="col-auto">
                                        <span type="button" href="();" onclick="deleteESE(ese_existent_P_{{ i.ese_id }})">❌</span>
                                    </div>
                                    <div class="col-auto">
                                        <input class="form-control form-control-sm"
                                               type="number" required
                                               value="{{ Event_structure.query.get(i.ese_id).rank }}"
                                               id="rank_existent_P_{{ i.ese_id }}"
                                               name="rank_existent_P_{{ i.ese_id }}"
                                               >
                                    </div>
                                    <div class="col-auto">
                                        <select class="form-select form-select-sm" id="status_ese_existent_P_{{ i.ese_id }}" name="status_ese_existent_P_{{ i.ese_id }}">
                                            <option value="1" {% if Event_structure.query.get(i.ese_id).status == 1 %}selected{% endif %}>ассерция</option>
                                            <option value="2" {% if Event_structure.query.get(i.ese_id).status == 2 %}selected{% endif %}>пресуппозиция</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-9 col-xxl-2">
                                    <div class="form-floating">
                                        <select class="form-select" id="is_child_existent_P_{{ i.ese_id }}" name="is_child_existent_P_{{ i.ese_id }}">
                                            <option value="">текущий</option>
                                            {% for t in Templates.query.all() %}
                                                {% if t.templ_id != templ_id %}
                                                    <option value="{{ t.templ_id }}" {% if Event_structure_relations.query.filter_by(ese_id=i.ese_id, target_id=t.templ_id, type=3).first() %} selected{% endif %}>{{t.templ}}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                        <label for="is_child_existent_P_{{ i.ese_id }}">Родительский шаблон</label>
                                    </div>
                                </div>
                                <div class="col-12 col-xxl-2">
                                    <div class="form-floating">
                                        <select class="form-select" id="control_existent_P_{{ i.ese_id }}" name="control_existent_P_{{ i.ese_id }}">
                                            <option value="1" {% if Event_structure.query.get(i.ese_id).controllable == 1 %}selected{% endif %}>контролируемое</option>
                                            <option value="2" {% if Event_structure.query.get(i.ese_id).controllable == 2 %}selected{% endif %}>неконтролируемое</option>
                                            <option value="3" {% if Event_structure.query.get(i.ese_id).controllable == 3 %}selected{% endif %}>(не)контролируемое</option>
                                        </select>
                                        <label for="control_existent_P_{{ i.ese_id }}">Контролируемость</label>
                                    </div>
                                </div>
                                <div class="col-12 col-sm-12 col-xxl-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control overflow-auto" id="existent_P_{{ i.ese_id }}"
                                               name="existent_P_{{ i.ese_id }}"
                                               placeholder="Введите текст"
                                               list="P_list"
                                               oninput="suggestions('P', existent_P_{{ i.ese_id }}.value)"
                                               value="{{ Event_structure.query.get(i.ese_id).ese }}"
                                        >
                                        <label for="existent_P_{{ i.ese_id }}">Введите описание</label>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="row row-cols-2 mb-2">
                        <div class="col-auto">
                            <span class="form-label h6">Завершение действия</span>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-sm btn-outline-success mb-2" onclick="addElement('Final_stage')" type="button">
                                <span class="text-center">Добавить</span>
                            </button>
                        </div>
                    </div>
                    <div class="row row-cols-1 g-2 overflow-auto border-bottom border-2 mb-2" id="Final_stage" style="max-height: 30vh;">
                        {% for i in Event_structure_relations.query.filter_by(target_id=m.m_id, type=2).join(Event_structure, Event_structure_relations.ese_id==Event_structure.ese_id).filter(Event_structure.type==4).order_by(Event_structure.rank.asc()).all() %}
                            <div class="col row mb-1 align-items-center justify-content-start g-2 p-1" id="ese_existent_F_{{ i.ese_id }}">
                                <div class="col-3 col-xxl-2 g-2 mt-0 row row-cols-1 align-items-center justify-content-center">
                                    <div class="col-auto">
                                        <span type="button" href="();" onclick="deleteESE(ese_existent_F_{{ i.ese_id }})">❌</span>
                                    </div>
                                    <div class="col-auto">
                                        <input class="form-control form-control-sm"
                                               type="number" required
                                               value="{{ Event_structure.query.get(i.ese_id).rank }}"
                                               id="rank_existent_F_{{ i.ese_id }}"
                                               name="rank_existent_F_{{ i.ese_id }}"
                                               >
                                    </div>
                                    <div class="col-auto">
                                        <select class="form-select form-select-sm" id="status_ese_existent_F_{{ i.ese_id }}" name="status_ese_existent_F_{{ i.ese_id }}">
                                            <option value="1" {% if Event_structure.query.get(i.ese_id).status == 1 %}selected{% endif %}>ассерция</option>
                                            <option value="2" {% if Event_structure.query.get(i.ese_id).status == 2 %}selected{% endif %}>пресуппозиция</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-9 col-xxl-2">
                                    <div class="form-floating">
                                        <select class="form-select" id="is_child_existent_F_{{ i.ese_id }}" name="is_child_existent_F_{{ i.ese_id }}">
                                            <option value="">текущий</option>
                                            {% for t in Templates.query.all() %}
                                                {% if t.templ_id != templ_id %}
                                                    <option value="{{ t.templ_id }}" {% if Event_structure_relations.query.filter_by(ese_id=i.ese_id, target_id=t.templ_id, type=3).first() %} selected{% endif %}>{{t.templ}}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                        <label for="is_child_existent_F_{{ i.ese_id }}">Родительский шаблон</label>
                                    </div>
                                </div>
                                <div class="col-12 col-xxl-2">
                                    <div class="form-floating">
                                        <select class="form-select" id="control_existent_F_{{ i.ese_id }}" name="control_existent_F_{{ i.ese_id }}">
                                            <option value="1" {% if Event_structure.query.get(i.ese_id).controllable == 1 %}selected{% endif %}>контролируемое</option>
                                            <option value="2" {% if Event_structure.query.get(i.ese_id).controllable == 2 %}selected{% endif %}>неконтролируемое</option>
                                            <option value="3" {% if Event_structure.query.get(i.ese_id).controllable == 3 %}selected{% endif %}>(не)контролируемое</option>
                                        </select>
                                        <label for="control_existent_F_{{ i.ese_id }}">Контролируемость</label>
                                    </div>
                                </div>
                                <div class="col-12 col-sm-12 col-xxl-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="existent_F_{{ i.ese_id }}"
                                               name="existent_F_{{ i.ese_id }}"
                                               placeholder="Введите текст"
                                               list="F_list"
                                               oninput="suggestions('F', existent_F_{{ i.ese_id }}.value)"
                                               value="{{ Event_structure.query.get(i.ese_id).ese }}"
                                        >
                                        <label for="existent_F_{{ i.ese_id }}">Введите описание</label>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="row row-cols-2 mb-2">
                        <div class="col-auto">
                            <span class="form-label h6">Результат</span>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-sm btn-outline-success mb-2" onclick="addElement('Result')" type="button">
                                <span class="text-center">Добавить</span>
                            </button>
                        </div>
                    </div>
                    <div class="row row-cols-1 g-2 overflow-auto border-bottom border-2 mb-2" id="Result" style="max-height: 30vh;">
                        {% for i in Event_structure_relations.query.filter_by(target_id=m.m_id, type=2).join(Event_structure, Event_structure_relations.ese_id==Event_structure.ese_id).filter(Event_structure.type==5).order_by(Event_structure.rank.asc()).all() %}
                            <div class="col row mb-1 align-items-center justify-content-start g-2 p-1" id="ese_existent_R_{{ i.ese_id }}">
                                <div class="col-3 col-xxl-2 g-2 mt-0 row row-cols-1 align-items-center justify-content-center">
                                    <div class="col-auto">
                                        <span type="button" href="();" onclick="deleteESE(ese_existent_R_{{ i.ese_id }})">❌</span>
                                    </div>
                                    <div class="col-auto">
                                        <input class="form-control form-control-sm"
                                               type="number" required
                                               value="{{ Event_structure.query.get(i.ese_id).rank }}"
                                               id="rank_existent_R_{{ i.ese_id }}"
                                               name="rank_existent_R_{{ i.ese_id }}"
                                               >
                                    </div>
                                    <div class="col-auto">
                                        <select class="form-select form-select-sm" id="status_ese_existent_R_{{ i.ese_id }}" name="status_ese_existent_R_{{ i.ese_id }}">
                                            <option value="1" {% if Event_structure.query.get(i.ese_id).status == 1 %}selected{% endif %}>ассерция</option>
                                            <option value="2" {% if Event_structure.query.get(i.ese_id).status == 2 %}selected{% endif %}>пресуппозиция</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-9 col-xxl-2">
                                    <div class="form-floating">
                                        <select class="form-select" id="is_child_existent_R_{{ i.ese_id }}" name="is_child_existent_R_{{ i.ese_id }}">
                                            <option value="">текущий</option>
                                            {% for t in Templates.query.all() %}
                                                {% if t.templ_id != templ_id %}
                                                    <option value="{{ t.templ_id }}" {% if Event_structure_relations.query.filter_by(ese_id=i.ese_id, target_id=t.templ_id, type=3).first() %} selected{% endif %}>{{t.templ}}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                        <label for="is_child_existent_R_{{ i.ese_id }}">Родительский шаблон</label>
                                    </div>
                                </div>
                                <div class="col-12 col-xxl-2">
                                    <div class="form-floating">
                                        <select class="form-select" id="control_existent_R_{{ i.ese_id }}" name="control_existent_R_{{ i.ese_id }}">
                                            <option value="1" {% if Event_structure.query.get(i.ese_id).controllable == 1 %}selected{% endif %}>контролируемое</option>
                                            <option value="2" {% if Event_structure.query.get(i.ese_id).controllable == 2 %}selected{% endif %}>неконтролируемое</option>
                                            <option value="3" {% if Event_structure.query.get(i.ese_id).controllable == 3 %}selected{% endif %}>(не)контролируемое</option>
                                        </select>
                                        <label for="control_existent_R_{{ i.ese_id }}">Контролируемость</label>
                                    </div>
                                </div>
                                <div class="col-12 col-sm-12 col-xxl-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="existent_R_{{ i.ese_id }}"
                                               name="existent_R_{{ i.ese_id }}"
                                               placeholder="Введите текст"
                                               list="R_list"
                                               oninput="suggestions('R', existent_R_{{ i.ese_id }}.value)"
                                               value="{{ Event_structure.query.get(i.ese_id).ese }}"
                                        >
                                        <label for="existent_R_{{ i.ese_id }}">Введите описание</label>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="row row-cols-2 mb-2">
                        <div class="col-auto">
                            <span class="form-label h6">Следствие</span>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-sm btn-outline-success mb-2" onclick="addElement('Implication')" type="button">
                                <span class="text-center">Добавить</span>
                            </button>
                        </div>
                    </div>
                    <div class="row row-cols-1 g-2 overflow-auto" id="Implication" style="max-height: 30vh;">
                        {% for i in Event_structure_relations.query.filter_by(target_id=m.m_id, type=2).join(Event_structure, Event_structure_relations.ese_id==Event_structure.ese_id).filter(Event_structure.type==6).order_by(Event_structure.rank.asc()).all() %}
                            <div class="col row mb-1 align-items-center justify-content-start g-2 p-1" id="ese_existent_Impl_{{ i.ese_id }}">
                                <div class="col-3 col-xxl-2 g-2 mt-0 row row-cols-1 align-items-center justify-content-center">
                                    <div class="col-auto">
                                        <span type="button" href="();" onclick="deleteESE(ese_existent_Impl_{{ i.ese_id }})">❌</span>
                                    </div>
                                    <div class="col-auto">
                                        <input class="form-control form-control-sm"
                                               type="number" required
                                               value="{{ Event_structure.query.get(i.ese_id).rank }}"
                                               id="rank_existent_Impl_{{ i.ese_id }}"
                                               name="rank_existent_Impl_{{ i.ese_id }}"
                                               >
                                    </div>
                                </div>
                                <div class="col-9 col-xxl-2">
                                    <div class="form-floating">
                                        <select class="form-select" id="is_child_existent_Impl_{{ i.ese_id }}" name="is_child_existent_Impl_{{ i.ese_id }}">
                                            <option value="">текущий</option>
                                            {% for t in Templates.query.all() %}
                                                {% if t.templ_id != templ_id %}
                                                    <option value="{{ t.templ_id }}" {% if Event_structure_relations.query.filter_by(ese_id=i.ese_id, target_id=t.templ_id, type=3).first() %} selected{% endif %}>{{t.templ}}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                        <label for="is_child_existent_Impl_{{ i.ese_id }}">Родительский шаблон</label>
                                    </div>
                                </div>
                                <div class="col-12 col-xxl-2">
                                    <div class="form-floating">
                                        <select class="form-select" id="control_existent_Impl_{{ i.ese_id }}" name="control_existent_Impl_{{ i.ese_id }}">
                                            <option value="1" {% if Event_structure.query.get(i.ese_id).controllable == 1 %}selected{% endif %}>контролируемое</option>
                                            <option value="2" {% if Event_structure.query.get(i.ese_id).controllable == 2 %}selected{% endif %}>неконтролируемое</option>
                                            <option value="3" {% if Event_structure.query.get(i.ese_id).controllable == 3 %}selected{% endif %}>(не)контролируемое</option>
                                        </select>
                                        <label for="control_existent_Impl_{{ i.ese_id }}">Контролируемость</label>
                                    </div>
                                </div>
                                <div class="col-12 col-xxl-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="existent_Impl_{{ i.ese_id }}"
                                               name="existent_Impl_{{ i.ese_id }}"
                                               placeholder="Введите текст"
                                               list="Impl_list"
                                               oninput="suggestions('Impl', existent_Impl_{{ i.ese_id }}.value)"
                                               value="{{ Event_structure.query.get(i.ese_id).ese }}"
                                               >
                                        <label for="existent_Impl_{{ i.ese_id }}">Введите описание</label>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="container mb-2">
                <div class="row g-2 mb-2 align-items-center justify-content-start">
                    <div class="col-auto">
                        <span class="form-label h5">Связанные единицы</span>
                    </div>
                </div>
                <div class="container mb-2">
                    ???
                </div>
            </div>
        </form>
        <datalist id="sr_list"></datalist>
        <datalist id="I_list"></datalist>
        <datalist id="B_list"></datalist>
        <datalist id="P_list"></datalist>
        <datalist id="F_list"></datalist>
        <datalist id="R_list"></datalist>
        <datalist id="Impl_list"></datalist>
    </div>
    <script type='text/javascript'>
        for (var i = 0; i < document.getElementsByTagName('textarea').length; ++i) {
            autosize(document.getElementsByTagName('textarea')[i]);
            }

        function addParticipant() {
            if ($('#participants').find('> div').length > 0) {
                var current_num = $('#participants').find('> div').length + 1;
            } else {
                var current_num = 1
            }
            $('#participants').append(
                `<div class="col row row-cols-1 align-items-center justify-content-center g-2 border-bottom border-1" id="participant_${current_num}">
                    <div class="col-auto row align-items-center justify-content-center g-2">
                        <div class="col-auto">
                            <button type="button" class="btn btn-sm btn-outline btn-outline-danger" onclick="deleteParticipant(participant_${current_num})">
                                Удалить
                            </button>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="label_${current_num}"
                                   name="label_${current_num}"
                                   placeholder="Введите текст"
                                   oninput="checkLabelAvailability(this, this.value)"
                                   required
                            >
                            <label for="label_${current_num}">Ярлык</label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="sr_${current_num}"
                                   name="sr_${current_num}"
                                   placeholder="Введите текст"
                                   list="sr_list"
                                   oninput="suggestions('sr', sr_${current_num}.value)"
                            >
                            <label for="sr_${current_num}">Семантическая роль</label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="col-12 align-items-center text-center">
                            <span style="text-decoration-line: none; font-variant: small-caps">Мереология</span>
                        </div>
                        <div class="col-12 align-items-center text-center mb-1">
                            <a class="text-primary h5"
                               href="javascript:;"
                               role="button"
                               data-bs-toggle="dropdown"
                               data-bs-auto-close="outside"
                               aria-expanded="false"
                               style="text-decoration-line: none; font-size: smaller"
                               id="mer_ls_${current_num}"
                            >
                                <span>Добавить</span>
                            </a>
                            <ul class="dropdown-menu overflow-auto p-1" style="height: 200px">
                                {% for l in Labels.query.filter_by(type=1).order_by(Labels.rank.asc(), Labels.l.asc()).all() %}
                                    <li>
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                   type="checkbox"
                                                   value="{{ l.l_id }}"
                                                   id="mer_${current_num}_{{ l.l_id }}"
                                                   name="mer_${current_num}_{{ l.l_id }}"
                                                   full_name="{{ l.l }}"
                                                   onclick="addLabels('mer_ls_${current_num}', 'mer_${current_num}_{{ l.l_id }}', 'Добавить')"
                                            >
                                            <label class="form-check-label"
                                                   for="mer_${current_num}_{{ l.l_id }}"
                                                   style="font-variant: small-caps"
                                            >
                                                {{ l.l }}
                                            </label>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="form-floating">
                            <input type="text" class="form-control" id="new_mer_${current_num}"
                                   name="new_mer_${current_num}"
                                   placeholder="Введите текст"
                            >
                            <label for="new_mer_${current_num}">Введите новые тэги через запятую</label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="col-12 align-items-center text-center">
                            <span style="text-decoration-line: none; font-variant: small-caps">Таксономия</span>
                        </div>
                        <div class="col-12 align-items-center text-center mb-1">
                            <a class="text-primary h5"
                               href="javascript:;"
                               role="button"
                               data-bs-toggle="dropdown"
                               data-bs-auto-close="outside"
                               aria-expanded="false"
                               style="text-decoration-line: none; font-size: smaller"
                               id="tax_ls_${current_num}"
                            >
                                <span>Добавить</span>
                            </a>
                            <ul class="dropdown-menu overflow-auto p-1" style="height: 200px">
                                {% for l in Labels.query.filter_by(type=2).order_by(Labels.rank.asc(), Labels.l.asc()).all() %}
                                    <li>
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                   type="checkbox"
                                                   value="{{ l.l_id }}"
                                                   id="tax_${current_num}_{{ l.l_id }}"
                                                   name="tax_${current_num}_{{ l.l_id }}"
                                                   full_name="{{ l.l }}"
                                                   onclick="addLabels('tax_ls_${current_num}', 'tax_${current_num}_{{ l.l_id }}', 'Добавить')"
                                            >
                                            <label class="form-check-label"
                                                   for="tax_${current_num}_{{ l.l_id }}"
                                                   style="font-variant: small-caps"
                                            >
                                                {{ l.l }}
                                            </label>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="form-floating">
                            <input type="text" class="form-control" id="new_tax_${current_num}"
                                   name="new_tax_${current_num}"
                                   placeholder="Введите текст"
                            >
                            <label for="new_tax_${current_num}">Введите новые тэги через запятую</label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="col-12 align-items-center text-center">
                            <span style="text-decoration-line: none; font-variant: small-caps">Топология</span>
                        </div>
                        <div class="col-12 align-items-center text-center mb-1">
                            <a class="text-primary h5"
                               href="javascript:;"
                               role="button"
                               data-bs-toggle="dropdown"
                               data-bs-auto-close="outside"
                               aria-expanded="false"
                               style="text-decoration-line: none; font-size: smaller"
                               id="top_ls_${current_num}"
                            >
                                <span>Добавить</span>
                            </a>
                            <ul class="dropdown-menu overflow-auto p-1" style="height: 200px">
                                {% for l in Labels.query.filter_by(type=3).order_by(Labels.rank.asc(), Labels.l.asc()).all() %}
                                    <li>
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                   type="checkbox"
                                                   value="{{ l.l_id }}"
                                                   id="top_${current_num}_{{ l.l_id }}"
                                                   name="top_${current_num}_{{ l.l_id }}"
                                                   full_name="{{ l.l }}"
                                                   onclick="addLabels('top_ls_${current_num}', 'top_${current_num}_{{ l.l_id }}', 'Добавить')"
                                            >
                                            <label class="form-check-label"
                                                   for="top_${current_num}_{{ l.l_id }}"
                                                   style="font-variant: small-caps"
                                            >
                                                {{ l.l }}
                                            </label>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="form-floating">
                            <input type="text" class="form-control" id="new_top_${current_num}"
                                   name="new_top_${current_num}"
                                   placeholder="Введите текст"
                            >
                            <label for="new_top_${current_num}">Введите новые тэги через запятую</label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="other_${current_num}"
                                   name="other_${current_num}"
                                   placeholder="Введите текст"
                            >
                            <label for="other_${current_num}">Другое</label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-floating">
                            <select class="form-select" id="status_${current_num}" name="status_${current_num}">
                                <option selected value="1">ядерный</option>
                                <option value="2">периферийный</option>
                                <option value="3">инкорпорированный</option>
                            </select>
                            <label for="status_${current_num}">Этот участник</label>
                        </div>
                    </div>
                    <div class="col mb-2">
                        <div>
                            <label for="is_child_${current_num}" class="form-label">Родительский участник</label>
                            <select class="form-select" size="4" id="is_child_${current_num}" name="is_child_${current_num}" multiple>
                                <option value="">отсутствует</option>
                                {% for p in Participants.query.filter_by(type=1).all() %}
                                    <option value="{{ p.participant_id }}">
                                        {{ p.participant }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>`);
            for (var i = 0; i < document.getElementsByTagName('textarea').length; ++i) {
            autosize(document.getElementsByTagName('textarea')[i]);
            }
        }

        function addExistentParticipant(id) {
            if ($('#participants').find('> div').length > 0) {
                var current_num = $('#participants').find('> div').length + 1;
            } else {
                var current_num = 1
            }
            if ($(`:input[name=existent_participant_${id}]`).length) {
                return alert('Этот участник уже был добавлен.')
            }
            var packet = {
                    type: 'existent_participant',
                    input: id
                };
                fetch('{{ url_for('editing_autocomplete') }}', {
                    method: 'POST',
                    credentials: 'include',
                    body: JSON.stringify(packet),
                    cache: 'no-cache',
                    headers: new Headers({
                        'content-type': 'application/json'
                    })
                })
                .then(function (response) {
                    if (response.status == 200) {
                        $(`#select_new option[value=""]`).prop('selected', true);
                        response.json().then(function (items) {
                            $('#participants').append(
                                `<div class="col row row-cols-1 align-items-center justify-content-center g-2 border-bottom border-1" id="participant_${current_num}">
                                <div class="col-auto row align-items-center justify-content-center g-2">
                                    <div class="col-auto">
                                        <button type="button" class="btn btn-sm btn-outline btn-outline-danger" onclick="deleteParticipant(participant_${current_num})">
                                            Удалить
                                        </button>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="label_${current_num}"
                                               name="label_${current_num}"
                                               placeholder="Введите текст"
                                               oninput="checkLabelAvailability(this, this.value)"
                                               required
                                        >
                                        <label for="label_${current_num}">Ярлык</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="sr_${current_num}"
                                               name="sr_${current_num}"
                                               placeholder="Введите текст"
                                               list="sr_list"
                                               value="${items['sr']}"
                                               oninput="suggestions('sr', sr_${current_num}.value)"
                                        >
                                        <label for="sr_${current_num}">Семантическая роль</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="col-12 align-items-center text-center">
                                        <span style="text-decoration-line: none; font-variant: small-caps">Мереология</span>
                                    </div>
                                    <div class="col-12 align-items-center text-center mb-1">
                                        <a class="text-primary h5"
                                           href="javascript:;"
                                           role="button"
                                           data-bs-toggle="dropdown"
                                           data-bs-auto-close="outside"
                                           aria-expanded="false"
                                           style="text-decoration-line: none; font-size: smaller"
                                           id="mer_ls_${current_num}"
                                        >
                                            ${items['mer_names']}
                                        </a>
                                        <ul class="dropdown-menu overflow-auto p-1" style="height: 200px">
                                            {% for l in Labels.query.filter_by(type=1).all() %}
                                                <li>
                                                    <div class="form-check">
                                                        <input class="form-check-input"
                                                               type="checkbox"
                                                               value="{{ l.l_id }}"
                                                               id="mer_${current_num}_{{ l.l_id }}"
                                                               name="mer_${current_num}_{{ l.l_id }}"
                                                               full_name="{{ l.l }}"
                                                               onclick="addLabels('mer_ls_${current_num}', 'mer_${current_num}_{{ l.l_id }}', 'Добавить')"
                                                        >
                                                        <label class="form-check-label"
                                                               for="mer_${current_num}_{{ l.l_id }}"
                                                               style="font-variant: small-caps"
                                                        >
                                                            {{ l.l }}
                                                        </label>
                                                    </div>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="new_mer_${current_num}"
                                               name="new_mer_${current_num}"
                                               placeholder="Введите текст"
                                        >
                                        <label for="new_mer_${current_num}">Введите новые тэги через запятую</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="col-12 align-items-center text-center">
                                        <span style="text-decoration-line: none; font-variant: small-caps">Таксономия</span>
                                    </div>
                                    <div class="col-12 align-items-center text-center mb-1">
                                        <a class="text-primary h5"
                                           href="javascript:;"
                                           role="button"
                                           data-bs-toggle="dropdown"
                                           data-bs-auto-close="outside"
                                           aria-expanded="false"
                                           style="text-decoration-line: none; font-size: smaller"
                                           id="tax_ls_${current_num}"
                                        >
                                            ${items['tax_names']}
                                        </a>
                                        <ul class="dropdown-menu overflow-auto p-1" style="height: 200px">
                                            {% for l in Labels.query.filter_by(type=2).all() %}
                                                <li>
                                                    <div class="form-check">
                                                        <input class="form-check-input"
                                                               type="checkbox"
                                                               value="{{ l.l_id }}"
                                                               id="tax_${current_num}_{{ l.l_id }}"
                                                               name="tax_${current_num}_{{ l.l_id }}"
                                                               full_name="{{ l.l }}"
                                                               onclick="addLabels('tax_ls_${current_num}', 'tax_${current_num}_{{ l.l_id }}', 'Добавить')"
                                                        >
                                                        <label class="form-check-label"
                                                               for="tax_${current_num}_{{ l.l_id }}"
                                                               style="font-variant: small-caps"
                                                        >
                                                            {{ l.l }}
                                                        </label>
                                                    </div>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="new_tax_${current_num}"
                                               name="new_tax_${current_num}"
                                               placeholder="Введите текст"
                                        >
                                        <label for="new_tax_${current_num}">Введите новые тэги через запятую</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="col-12 align-items-center text-center">
                                        <span style="text-decoration-line: none; font-variant: small-caps">Топология</span>
                                    </div>
                                    <div class="col-12 align-items-center text-center mb-1">
                                        <a class="text-primary h5"
                                           href="javascript:;"
                                           role="button"
                                           data-bs-toggle="dropdown"
                                           data-bs-auto-close="outside"
                                           aria-expanded="false"
                                           style="text-decoration-line: none; font-size: smaller"
                                           id="top_ls_${current_num}"
                                        >
                                            ${items['top_names']}
                                        </a>
                                        <ul class="dropdown-menu overflow-auto p-1" style="height: 200px">
                                            {% for l in Labels.query.filter_by(type=3).all() %}
                                                <li>
                                                    <div class="form-check">
                                                        <input class="form-check-input"
                                                               type="checkbox"
                                                               value="{{ l.l_id }}"
                                                               id="top_${current_num}_{{ l.l_id }}"
                                                               name="top_${current_num}_{{ l.l_id }}"
                                                               full_name="{{ l.l }}"
                                                               onclick="addLabels('top_ls_${current_num}', 'top_${current_num}_{{ l.l_id }}', 'Добавить')"
                                                        >
                                                        <label class="form-check-label"
                                                               for="top_${current_num}_{{ l.l_id }}"
                                                               style="font-variant: small-caps"
                                                        >
                                                            {{ l.l }}
                                                        </label>
                                                    </div>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="new_top_${current_num}"
                                               name="new_top_${current_num}"
                                               placeholder="Введите текст"
                                        >
                                        <label for="new_top_${current_num}">Введите новые тэги через запятую</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="other_${current_num}"
                                               name="other_${current_num}"
                                               placeholder="Введите текст"
                                               value="${items['other']}"
                                        >
                                        <label for="other_${current_num}">Другое</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-floating">
                                        <select class="form-select" id="status_${current_num}" name="status_${current_num}">
                                            <option selected value="1">ядерный</option>
                                            <option value="2">периферийный</option>
                                            <option value="3">инкорпорированный</option>
                                        </select>
                                        <label for="status_${current_num}">Этот участник</label>
                                    </div>
                                </div>
                                <div class="col mb-2">
                                    <div>
                                        <label for="is_child_${current_num}" class="form-label">Родительский участник</label>
                                        <select class="form-select" size="4" id="is_child_${current_num}" name="is_child_${current_num}" multiple>
                                            <option value="">отсутствует</option>
                                            {% for p in Participants.query.filter_by(type=1).all() %}
                                                <option value="{{ p.participant_id }}">
                                                    {{ p.participant }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>`);
                            $(`#status_${current_num} option[value="${items['status']}"`).prop('selected', true);
                            for (let i of items['tax']) {
                                $(`#tax_${current_num}_${i}`).prop('checked', true);
                            };
                            for (let i of items['top']) {
                                $(`#top_${current_num}_${i}`).prop('checked', true);
                            };
                            for (let i of items['mer']) {
                                $(`#mer_${current_num}_${i}`).prop('checked', true);
                            };
                            for (let i of items['parents']) {
                                $(`#is_child_${current_num} option[value="${i}"`).prop('selected', true);
                            };
                            $(`#is_child_${current_num} option[value="${id}"`).prop('selected', true);
                        });
                    };
                });
            for (var i = 0; i < document.getElementsByTagName('textarea').length; ++i) {
            autosize(document.getElementsByTagName('textarea')[i]);
            }
        }

        function addElement(id) {
            if ($(`#${id}`).find('> div').length > 0) {
                var current_num = $(`#${id}`).find('> div').length + 1;
            } else {
                var current_num = 1
            }
            if (id == 'Implication') {
                var type = 'Impl';
                var assert_presuppose = ``
            } else {
                var type = Array.from(id)[0];
                var assert_presuppose =
            `
            <div class="col-auto">
                <select class="form-select form-select-sm" id="status_ese_${type}_${current_num}" name="status_ese_${type}_${current_num}">
                    <option value="1">ассерция</option>
                    <option value="2">пресуппозиция</option>
                </select>
            </div>
            `
            }
            $(`#${id}`).append(
            `
            <div class="col row mb-1 align-items-center justify-content-start g-2 p-1">
                <div class="col-3 col-xxl-2 g-2 mt-0 row align-items-center justify-content-center">
                    <div class="col-auto">
                        <input class="form-control form-control-sm"
                               type="number" required
                               value="${current_num}"
                               id="rank_${type}_${current_num}"
                               name="rank_${type}_${current_num}"
                               >
                    </div>
                    ${assert_presuppose}
                </div>
                <div class="col-9 col-xxl-2">
                    <div class="form-floating">
                        <select class="form-select" id="is_child_${type}_${current_num}" name="is_child_${type}_${current_num}">
                            <option value="">нет</option>
                            {% for t in Templates.query.all() %}
                                <option value="{{t.templ_id}}">{{t.templ}}</option>
                            {% endfor %}
                        </select>
                        <label for="is_child_${type}_${current_num}">Родительский шаблон</label>
                    </div>
                </div>
                <div class="col-12 col-xxl-2">
                    <div class="form-floating">
                        <select class="form-select" id="control_${type}_${current_num}" name="control_${type}_${current_num}">
                            <option value="1">контролируемое</option>
                            <option value="2">неконтролируемое</option>
                            <option value="3">(не)контролируемое</option>
                        </select>
                        <label for="control_${type}_${current_num}">Контролируемость</label>
                    </div>
                </div>
                <div class="col-12 col-sm-12 col-xxl-6">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="${type}_${current_num}"
                               name="${type}_${current_num}"
                               placeholder="Введите текст"
                               list="${type}_list"
                               oninput="suggestions('${type}', ${type}_${current_num}.value)"
                        >
                        <label for="${type}_${current_num}">Введите описание</label>
                    </div>
                </div>
            </div>
            `
                );
            for (var i = 0; i < document.getElementsByTagName('textarea').length; ++i) {
            autosize(document.getElementsByTagName('textarea')[i]);
            }
        }

        function deleteParticipant(participant) {
            if (participant.id.includes('existent')) {
                var p_id = participant.id.split('_').slice(-1);
                $('#meaning').append(
                    `<input class="d-none" type="text" name="delete_p_${p_id}" value="${p_id}">`
                )
            };
            participant.remove()
        };

        function deleteExample(example) {
            if (example.id.includes('existing')) {
                var e_id = example.id.split('_').slice(-1);
                $('#meaning').append(
                    `<input class="d-none" type="text" name="delete_e_${e_id}" value="${e_id}">`
                )
            };
            example.remove()
        };
        
        function deleteESE(ese) {
            if (ese.id.includes('existent')) {
                var ese_id = ese.id.split('_').slice(-1);
                $('#meaning').append(
                    `<input class="d-none" type="text" name="delete_ese_${ese_id}" value="${ese_id}">`
                )
            };
            ese.remove()
        };

        function suggestions(type, input) {
            $(`#${type}_list`).empty();
            if (input.length > 2) {
                var packet = {
                    type: type,
                    input: input
                };
                fetch('{{ url_for('editing_autocomplete') }}', {
                    method: 'POST',
                    credentials: 'include',
                    body: JSON.stringify(packet),
                    cache: 'no-cache',
                    headers: new Headers({
                        'content-type': 'application/json'
                    })
                })
                .then(function (response) {
                    if (response.status == 200) {
                        response.json().then(function (items) {
                            for (var item in items) {
                                $(`#${type}_list`).append(
                                    `<option value="${items[item]}">`
                                )
                            }
                        })
                    }
                });
            }
        }

        $('#template').submit(function(event) {
            if ($('.is-invalid').length) {
                alert('Удостоверьтесь, что все ярлыки уникальны.')
                event.preventDefault();
                $('.is-invalid').focus();
            }
        });

        function addLabels(aim, dropdown, type) {
            if ($(`#${dropdown}`).is(':checked')) {
                const re_ns = RegExp('\n', 'g');
                const re_spaces = RegExp(' +$', 'gm');
                var current_text = $(`#${aim}`).text().replaceAll(re_ns, '').replace(re_spaces, '');
                if (current_text.match(type)) {
                    var selected = [$(`#${dropdown}`).attr('full_name')];
                } else {
                    var selected = [current_text, $(`#${dropdown}`).attr('full_name')];
                }
                $(`#${aim}`).text(selected.join(', '));
            } else {
                var label = $(`#${dropdown}`).attr('full_name');
                const re = RegExp(`(,)*( |^)${label}`.replace('\.', '\\\.'), 'g');
                const re_spaces = RegExp('[ \n]+$', 'gm');
                const re_beginning = RegExp('^[ \n]*, ', 'gm');
                var new_text = $(`#${aim}`).text().replace(re, '').replace(re_spaces, '');
                if (new_text == '') {
                    new_text = type
                }
                new_text = new_text.replace(re_beginning, '')
                $(`#${aim}`).text(new_text)
            }
        }
        
        function addExample() {
            if ($(`#examples`).find('> div').length > 0) {
                var current_num = $(`#examples`).find('> div').length + 1;
            } else {
                var current_num = 1
            }
            $(`#examples`).append(
            `<div class="col" id="example_column_${current_num}">
                <div class="card my-2">
                    <div class="container my-2 text-danger text-center">
                        <span type="button" href="();" onclick="example_column_${current_num}.remove()">Удалить</span>
                    </div>
                    <div class="container my-2">
                        <div class="form-floating">
                            <textarea class="form-control overflow-auto"
                                      id="government_${current_num}"
                                      name="government_${current_num}"
                                      placeholder="Пример"
                                      style="max-height: 300px"></textarea>
                            <label for="government_${current_num}">Формула управления</label>
                        </div>
                    </div>
                    <div class="container mb-2">
                        <div class="form-floating">
                            <textarea class="form-control overflow-auto"
                                      id="example_${current_num}"
                                      name="example_${current_num}"
                                      placeholder="Пример"
                                      style="max-height: 300px"></textarea>
                            <label for="example_${current_num}">Пример (в транскрипции)</label>
                        </div>
                    </div>
                    <div class="container mb-2">
                        <div class="form-floating">
                            <textarea class="form-control overflow-auto"
                                      id="original_script_current_num"
                                      name="original_script_${current_num}"
                                      placeholder="Пример"
                                      style="max-height: 300px"></textarea>
                            <label for="original_script_${current_num}">В графике</label>
                        </div>
                    </div>
                    <div class="container mb-2">
                        <div class="form-floating">
                            <textarea class="form-control overflow-auto"
                                      id="translation_${current_num}"
                                      name="translation_${current_num}"
                                      placeholder="Пример"
                                      style="max-height: 300px"></textarea>
                            <label for="translation_${current_num}">Перевод</label>
                        </div>
                    </div>
                    <div class="container mb-2">
                        <div class="form-floating">
                            <textarea class="form-control overflow-auto"
                                      id="source_${current_num}"
                                      name="source_${current_num}"
                                      placeholder="Пример"
                                      style="max-height: 300px"></textarea>
                            <label for="source_${current_num}">Источник</label>
                        </div>
                    </div>
                </div>
            </div>`
                );
            $('#examples').children().last().attr("tabindex",-1).focus();
            for (var i = 0; i < document.getElementsByTagName('textarea').length; ++i) {
            autosize(document.getElementsByTagName('textarea')[i]);
            };
        }
    </script>
{% endblock %}
