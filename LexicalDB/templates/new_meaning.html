{% extends 'base.html' %}
{% block title %}
    Добавление значения
{% endblock %}
{% block content %}
    <div class="container mb-2">
        <div class="container row mb-2 g-2 align-items-center justify-content-start">
            <div class="col-12 col-lg-9 row g-2">
                <div class="col-12">
                    <div class="form-floating">
                        <select form="meaning" class="form-select" id="based_on" name="based_on" onchange="addFromTemplate(this.value)">
                            <option value="">отсутствует</option>
                            {% for t in Templates.query.order_by(Templates.templ.asc()).all() %}
                                <option value="{{ t.templ_id }}">{{ t.templ }}</option>
                            {% endfor %}
                        </select>
                        <label for="based_on">
                            Родительский шаблон
                        </label>
                    </div>
                </div>
                <div class="col-12 mb-2">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="short_meaning" name="short_meaning" placeholder="meaning" form="meaning">
                        <label for="short_meaning">Краткая формулировка значения</label>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-3 row align-items-center justify-content-center g-2">
                <div class="col-12 text-center">
                    Лексема: <a href="{{ url_for('edit_lexeme', lex_id=lex_id) }}" target="_blank"><b>{{ Forms.query.filter_by(lex_id=lex_id).first().form }} (ID {{ lex_id }})</b></a>
                </div>
                <div class="col-12 col-lg-3 form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="hidden" name="hidden">
                    <label class="form-check-label" for="hidden" style="font-weight: bold;">
                           <abbr style="text-decoration: none" data-bs-toggle="tooltip" title="Доступна ли статья для поиска?">Скрыта</abbr>
                    </label>
                </div>
                <div class="col-12 text-center mb-2">
                    <button class="btn btn-sm btn-success" type="submit" form="meaning">
                        Сохранить
                    </button>
                </div>
            </div>
        </div>
        <form name="meaning" id="meaning" method="post">
            <div class="container row g-2 mb-2 align-items-center justify-content-start">
                <div class="col-auto">
                    <span class="form-label h5">Участники</span>
                </div>
                <div class="col-auto">
                    <button class="btn btn-sm btn-primary"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapse_participants"
                            aria-expanded="true"
                            aria-controls="collapse_participants"
                            onclick="if (this.classList.contains('collapsed')) {this.textContent = 'Показать'} else {this.textContent = 'Скрыть'};"
                            >
                        Скрыть
                    </button>
                </div>
                <div class="col-auto">
                    <button class="btn btn-sm btn-outline-success" onclick="addParticipant()" type="button">
                        <span class="text-center">Создать нового участника</span>
                    </button>
                </div>
                <div class="col-auto">
                    <select class="form-select form-select-sm" onchange="if (this.value) {addExistentParticipant(this.value)}" id="select_new">
                        <option selected value="">Создать с опорой на существующего</option>
                        {% for p in Participants.query.filter_by(type=1).all() %}
                            <option value="{{ p.participant_id }}">
                                {{ p.participant }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="collapse show container overflow-auto mb-2" style="max-height: 60vh;" id="collapse_participants">
                <div class="row row-cols-1 row-cols-lg-3 g-2" id="participants">
                </div>
            </div>
            <div class="container row g-2 mb-2 align-items-center justify-content-start">
                <div class="col-auto">
                    <span class="form-label h5">Примеры</span>
                </div>
                <div class="col-auto">
                    <button class="btn btn-sm btn-primary"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapse_examples"
                            aria-expanded="true"
                            aria-controls="collapse_examples"
                            onclick="if (this.classList.contains('collapsed')) {this.textContent = 'Показать'} else {this.textContent = 'Скрыть'};"
                            >
                        Скрыть
                    </button>
                </div>
                <div class="col-auto">
                    <button class="btn btn-sm btn-outline-success" onclick="addExample()" type="button">
                        <span class="text-center">Новый пример</span>
                    </button>
                </div>
            </div>
            <div class="container mb-2 row align-items-center justify-content-around overflow-auto collapse show" style="max-height: 60vh;" id="collapse_examples">
                <div class="row row-cols-1 g-2" id="examples">
                </div>
            </div>
            <div class="container mb-2">
                <div class="row g-2 mb-2 align-items-center justify-content-start">
                    <div class="col-auto">
                        <span class="form-label h5">Структура события</span>
                    </div>
                </div>
                <div class="container mb-2">
                    <div class="row row-cols-2 mb-2">
                        <div class="col-auto">
                            <span class="form-label h6">Начальное состояние</span>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-sm btn-outline-success mb-2" onclick="addElement('Initial_state')" type="button">
                                <span class="text-center">Добавить</span>
                            </button>
                        </div>
                    </div>
                    <div class="row row-cols-1 g-2 overflow-auto border-bottom border-2 mb-2" id="Initial_state" style="max-height: 30vh;">
                    </div>
                    <div class="row row-cols-2 mb-2">
                        <div class="col-auto">
                            <span class="form-label h6">Начало действия</span>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-sm btn-outline-success mb-2" onclick="addElement('Beginning')" type="button">
                                <span class="text-center">Добавить</span>
                            </button>
                        </div>
                    </div>
                    <div class="row row-cols-1 g-2 overflow-auto border-bottom border-2 mb-2" id="Beginning" style="max-height: 30vh;">
                    </div>
                    <div class="row row-cols-2 mb-2">
                        <div class="col-auto">
                            <span class="form-label h6">Процесс</span>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-sm btn-outline-success mb-2" onclick="addElement('Process')" type="button">
                                <span class="text-center">Добавить</span>
                            </button>
                        </div>
                    </div>
                    <div class="row row-cols-1 g-2 overflow-auto border-bottom border-2 mb-2" id="Process" style="max-height: 30vh;">
                    </div>
                    <div class="row row-cols-2 mb-2">
                        <div class="col-auto">
                            <span class="form-label h6">Завершение действия</span>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-sm btn-outline-success mb-2" onclick="addElement('Final_stage')" type="button">
                                <span class="text-center">Добавить</span>
                            </button>
                        </div>
                    </div>
                    <div class="row row-cols-1 g-2 overflow-auto border-bottom border-2 mb-2" id="Final_stage" style="max-height: 30vh;">
                    </div>
                    <div class="row row-cols-2 mb-2">
                        <div class="col-auto">
                            <span class="form-label h6">Результат</span>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-sm btn-outline-success mb-2" onclick="addElement('Result')" type="button">
                                <span class="text-center">Добавить</span>
                            </button>
                        </div>
                    </div>
                    <div class="row row-cols-1 g-2 overflow-auto border-bottom border-2 mb-2" id="Result" style="max-height: 30vh;">
                    </div>
                    <div class="row row-cols-2 mb-2">
                        <div class="col-auto">
                            <span class="form-label h6">Следствие</span>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-sm btn-outline-success mb-2" onclick="addElement('Implication')" type="button">
                                <span class="text-center">Добавить</span>
                            </button>
                        </div>
                    </div>
                    <div class="row row-cols-1 g-2 overflow-auto" id="Implication" style="max-height: 30vh;">
                    </div>
                </div>
            </div>
            <div class="container mb-2">
                <div class="row g-2 mb-2 align-items-center justify-content-start">
                    <div class="col-auto">
                        <span class="form-label h5">Связанные единицы</span>
                    </div>
                </div>
                <div class="container mb-2">
                    ???
                </div>
            </div>
        </form>
        <datalist id="sr_list"></datalist>
        <datalist id="I_list"></datalist>
        <datalist id="B_list"></datalist>
        <datalist id="P_list"></datalist>
        <datalist id="F_list"></datalist>
        <datalist id="R_list"></datalist>
        <datalist id="Impl_list"></datalist>
    </div>
    <script type='text/javascript'>
        for (var i = 0; i < document.getElementsByTagName('textarea').length; ++i) {
            autosize(document.getElementsByTagName('textarea')[i]);
            }

        function addParticipant() {
            if ($('#participants').find('> div').length > 0) {
                var current_num = $('#participants').find('> div').length + 1;
            } else {
                var current_num = 1
            }
            $('#participants').append(
                `<div class="col row row-cols-1 align-items-center justify-content-center g-2 border-bottom border-1" id="participant_${current_num}">
                    <div class="col-auto row align-items-center justify-content-center g-2">
                        <div class="col-auto">
                            <button type="button" class="btn btn-sm btn-outline btn-outline-danger" onclick="deleteParticipant(participant_${current_num})">
                                Удалить
                            </button>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="label_${current_num}"
                                   name="label_${current_num}"
                                   placeholder="Введите текст"
                                   oninput="checkLabelAvailability(this, this.value)"
                                   required
                            >
                            <label for="label_${current_num}">Ярлык</label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="sr_${current_num}"
                                   name="sr_${current_num}"
                                   placeholder="Введите текст"
                                   list="sr_list"
                                   oninput="suggestions('sr', sr_${current_num}.value)"
                            >
                            <label for="sr_${current_num}">Семантическая роль</label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="col-12 align-items-center text-center">
                            <span style="text-decoration-line: none; font-variant: small-caps">Мереология</span>
                        </div>
                        <div class="col-12 align-items-center text-center mb-1">
                            <a class="text-primary h5"
                               href="javascript:;"
                               role="button"
                               data-bs-toggle="dropdown"
                               data-bs-auto-close="outside"
                               aria-expanded="false"
                               style="text-decoration-line: none; font-size: smaller"
                               id="mer_ls_${current_num}"
                            >
                                <span>Добавить</span>
                            </a>
                            <ul class="dropdown-menu overflow-auto p-1" style="height: 200px">
                                {% for l in Labels.query.filter_by(type=1).order_by(Labels.rank.asc(), Labels.l.asc()).all() %}
                                    <li>
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                   type="checkbox"
                                                   value="{{ l.l_id }}"
                                                   id="mer_${current_num}_{{ l.l_id }}"
                                                   name="mer_${current_num}_{{ l.l_id }}"
                                                   full_name="{{ l.l }}"
                                                   onclick="addLabels('mer_ls_${current_num}', 'mer_${current_num}_{{ l.l_id }}', 'Добавить')"
                                            >
                                            <label class="form-check-label"
                                                   for="mer_${current_num}_{{ l.l_id }}"
                                                   style="font-variant: small-caps"
                                            >
                                                {{ l.l }}
                                            </label>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="form-floating">
                            <input type="text" class="form-control" id="new_mer_${current_num}"
                                   name="new_mer_${current_num}"
                                   placeholder="Введите текст"
                            >
                            <label for="new_mer_${current_num}">Введите новые тэги через запятую</label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="col-12 align-items-center text-center">
                            <span style="text-decoration-line: none; font-variant: small-caps">Таксономия</span>
                        </div>
                        <div class="col-12 align-items-center text-center mb-1">
                            <a class="text-primary h5"
                               href="javascript:;"
                               role="button"
                               data-bs-toggle="dropdown"
                               data-bs-auto-close="outside"
                               aria-expanded="false"
                               style="text-decoration-line: none; font-size: smaller"
                               id="tax_ls_${current_num}"
                            >
                                <span>Добавить</span>
                            </a>
                            <ul class="dropdown-menu overflow-auto p-1" style="height: 200px">
                                {% for l in Labels.query.filter_by(type=2).order_by(Labels.rank.asc(), Labels.l.asc()).all() %}
                                    <li>
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                   type="checkbox"
                                                   value="{{ l.l_id }}"
                                                   id="tax_${current_num}_{{ l.l_id }}"
                                                   name="tax_${current_num}_{{ l.l_id }}"
                                                   full_name="{{ l.l }}"
                                                   onclick="addLabels('tax_ls_${current_num}', 'tax_${current_num}_{{ l.l_id }}', 'Добавить')"
                                            >
                                            <label class="form-check-label"
                                                   for="tax_${current_num}_{{ l.l_id }}"
                                                   style="font-variant: small-caps"
                                            >
                                                {{ l.l }}
                                            </label>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="form-floating">
                            <input type="text" class="form-control" id="new_tax_${current_num}"
                                   name="new_tax_${current_num}"
                                   placeholder="Введите текст"
                            >
                            <label for="new_tax_${current_num}">Введите новые тэги через запятую</label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="col-12 align-items-center text-center">
                            <span style="text-decoration-line: none; font-variant: small-caps">Топология</span>
                        </div>
                        <div class="col-12 align-items-center text-center mb-1">
                            <a class="text-primary h5"
                               href="javascript:;"
                               role="button"
                               data-bs-toggle="dropdown"
                               data-bs-auto-close="outside"
                               aria-expanded="false"
                               style="text-decoration-line: none; font-size: smaller"
                               id="top_ls_${current_num}"
                            >
                                <span>Добавить</span>
                            </a>
                            <ul class="dropdown-menu overflow-auto p-1" style="height: 200px">
                                {% for l in Labels.query.filter_by(type=3).order_by(Labels.rank.asc(), Labels.l.asc()).all() %}
                                    <li>
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                   type="checkbox"
                                                   value="{{ l.l_id }}"
                                                   id="top_${current_num}_{{ l.l_id }}"
                                                   name="top_${current_num}_{{ l.l_id }}"
                                                   full_name="{{ l.l }}"
                                                   onclick="addLabels('top_ls_${current_num}', 'top_${current_num}_{{ l.l_id }}', 'Добавить')"
                                            >
                                            <label class="form-check-label"
                                                   for="top_${current_num}_{{ l.l_id }}"
                                                   style="font-variant: small-caps"
                                            >
                                                {{ l.l }}
                                            </label>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="form-floating">
                            <input type="text" class="form-control" id="new_top_${current_num}"
                                   name="new_top_${current_num}"
                                   placeholder="Введите текст"
                            >
                            <label for="new_top_${current_num}">Введите новые тэги через запятую</label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="other_${current_num}"
                                   name="other_${current_num}"
                                   placeholder="Введите текст"
                            >
                            <label for="other_${current_num}">Другое</label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-floating">
                            <select class="form-select" id="status_${current_num}" name="status_${current_num}">
                                <option selected value="1">ядерный</option>
                                <option value="2">периферийный</option>
                                <option value="3">инкорпорированный</option>
                            </select>
                            <label for="status_${current_num}">Этот участник</label>
                        </div>
                    </div>
                    <div class="col mb-2">
                        <div>
                            <label for="is_child_${current_num}" class="form-label">Родительский участник</label>
                            <select class="form-select" size="4" id="is_child_${current_num}" name="is_child_${current_num}" multiple>
                                <option value="">отсутствует</option>
                                {% for p in Participants.query.filter_by(type=1).all() %}
                                    <option value="{{ p.participant_id }}">
                                        {{ p.participant }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>`);
            for (var i = 0; i < document.getElementsByTagName('textarea').length; ++i) {
            autosize(document.getElementsByTagName('textarea')[i]);
            }
        }

        function addExistentParticipant(id) {
            if ($('#participants').find('> div').length > 0) {
                var current_num = $('#participants').find('> div').length + 1;
            } else {
                var current_num = 1
            }
            if ($(`:input[name=existent_participant_${id}]`).length) {
                return alert('Этот участник уже был добавлен.')
            }
            var packet = {
                    type: 'existent_participant',
                    input: id
                };
                fetch('{{ url_for('editing_autocomplete') }}', {
                    method: 'POST',
                    credentials: 'include',
                    body: JSON.stringify(packet),
                    cache: 'no-cache',
                    headers: new Headers({
                        'content-type': 'application/json'
                    })
                })
                .then(function (response) {
                    if (response.status == 200) {
                        $(`#select_new option[value=""]`).prop('selected', true);
                        response.json().then(function (items) {
                            $('#participants').append(
                                `<div class="col row row-cols-1 align-items-center justify-content-center g-2 border-bottom border-1" id="participant_${current_num}">
                                <div class="col-auto row align-items-center justify-content-center g-2">
                                    <div class="col-auto">
                                        <button type="button" class="btn btn-sm btn-outline btn-outline-danger" onclick="deleteParticipant(participant_${current_num})">
                                            Удалить
                                        </button>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="label_${current_num}"
                                               name="label_${current_num}"
                                               placeholder="Введите текст"
                                               oninput="checkLabelAvailability(this, this.value)"
                                               required
                                        >
                                        <label for="label_${current_num}">Ярлык</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="sr_${current_num}"
                                               name="sr_${current_num}"
                                               placeholder="Введите текст"
                                               list="sr_list"
                                               value="${items['sr']}"
                                               oninput="suggestions('sr', sr_${current_num}.value)"
                                        >
                                        <label for="sr_${current_num}">Семантическая роль</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="col-12 align-items-center text-center">
                                        <span style="text-decoration-line: none; font-variant: small-caps">Мереология</span>
                                    </div>
                                    <div class="col-12 align-items-center text-center mb-1">
                                        <a class="text-primary h5"
                                           href="javascript:;"
                                           role="button"
                                           data-bs-toggle="dropdown"
                                           data-bs-auto-close="outside"
                                           aria-expanded="false"
                                           style="text-decoration-line: none; font-size: smaller"
                                           id="mer_ls_${current_num}"
                                        >
                                            ${items['mer_names']}
                                        </a>
                                        <ul class="dropdown-menu overflow-auto p-1" style="height: 200px">
                                            {% for l in Labels.query.filter_by(type=1).all() %}
                                                <li>
                                                    <div class="form-check">
                                                        <input class="form-check-input"
                                                               type="checkbox"
                                                               value="{{ l.l_id }}"
                                                               id="mer_${current_num}_{{ l.l_id }}"
                                                               name="mer_${current_num}_{{ l.l_id }}"
                                                               full_name="{{ l.l }}"
                                                               onclick="addLabels('mer_ls_${current_num}', 'mer_${current_num}_{{ l.l_id }}', 'Добавить')"
                                                        >
                                                        <label class="form-check-label"
                                                               for="mer_${current_num}_{{ l.l_id }}"
                                                               style="font-variant: small-caps"
                                                        >
                                                            {{ l.l }}
                                                        </label>
                                                    </div>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="new_mer_${current_num}"
                                               name="new_mer_${current_num}"
                                               placeholder="Введите текст"
                                        >
                                        <label for="new_mer_${current_num}">Введите новые тэги через запятую</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="col-12 align-items-center text-center">
                                        <span style="text-decoration-line: none; font-variant: small-caps">Таксономия</span>
                                    </div>
                                    <div class="col-12 align-items-center text-center mb-1">
                                        <a class="text-primary h5"
                                           href="javascript:;"
                                           role="button"
                                           data-bs-toggle="dropdown"
                                           data-bs-auto-close="outside"
                                           aria-expanded="false"
                                           style="text-decoration-line: none; font-size: smaller"
                                           id="tax_ls_${current_num}"
                                        >
                                            ${items['tax_names']}
                                        </a>
                                        <ul class="dropdown-menu overflow-auto p-1" style="height: 200px">
                                            {% for l in Labels.query.filter_by(type=2).all() %}
                                                <li>
                                                    <div class="form-check">
                                                        <input class="form-check-input"
                                                               type="checkbox"
                                                               value="{{ l.l_id }}"
                                                               id="tax_${current_num}_{{ l.l_id }}"
                                                               name="tax_${current_num}_{{ l.l_id }}"
                                                               full_name="{{ l.l }}"
                                                               onclick="addLabels('tax_ls_${current_num}', 'tax_${current_num}_{{ l.l_id }}', 'Добавить')"
                                                        >
                                                        <label class="form-check-label"
                                                               for="tax_${current_num}_{{ l.l_id }}"
                                                               style="font-variant: small-caps"
                                                        >
                                                            {{ l.l }}
                                                        </label>
                                                    </div>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="new_tax_${current_num}"
                                               name="new_tax_${current_num}"
                                               placeholder="Введите текст"
                                        >
                                        <label for="new_tax_${current_num}">Введите новые тэги через запятую</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="col-12 align-items-center text-center">
                                        <span style="text-decoration-line: none; font-variant: small-caps">Топология</span>
                                    </div>
                                    <div class="col-12 align-items-center text-center mb-1">
                                        <a class="text-primary h5"
                                           href="javascript:;"
                                           role="button"
                                           data-bs-toggle="dropdown"
                                           data-bs-auto-close="outside"
                                           aria-expanded="false"
                                           style="text-decoration-line: none; font-size: smaller"
                                           id="top_ls_${current_num}"
                                        >
                                            ${items['top_names']}
                                        </a>
                                        <ul class="dropdown-menu overflow-auto p-1" style="height: 200px">
                                            {% for l in Labels.query.filter_by(type=3).all() %}
                                                <li>
                                                    <div class="form-check">
                                                        <input class="form-check-input"
                                                               type="checkbox"
                                                               value="{{ l.l_id }}"
                                                               id="top_${current_num}_{{ l.l_id }}"
                                                               name="top_${current_num}_{{ l.l_id }}"
                                                               full_name="{{ l.l }}"
                                                               onclick="addLabels('top_ls_${current_num}', 'top_${current_num}_{{ l.l_id }}', 'Добавить')"
                                                        >
                                                        <label class="form-check-label"
                                                               for="top_${current_num}_{{ l.l_id }}"
                                                               style="font-variant: small-caps"
                                                        >
                                                            {{ l.l }}
                                                        </label>
                                                    </div>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="new_top_${current_num}"
                                               name="new_top_${current_num}"
                                               placeholder="Введите текст"
                                        >
                                        <label for="new_top_${current_num}">Введите новые тэги через запятую</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="other_${current_num}"
                                               name="other_${current_num}"
                                               placeholder="Введите текст"
                                               value="${items['other']}"
                                        >
                                        <label for="other_${current_num}">Другое</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-floating">
                                        <select class="form-select" id="status_${current_num}" name="status_${current_num}">
                                            <option selected value="1">ядерный</option>
                                            <option value="2">периферийный</option>
                                            <option value="3">инкорпорированный</option>
                                        </select>
                                        <label for="status_${current_num}">Этот участник</label>
                                    </div>
                                </div>
                                <div class="col mb-2">
                                    <div>
                                        <label for="is_child_${current_num}" class="form-label">Родительский участник</label>
                                        <select class="form-select" size="4" id="is_child_${current_num}" name="is_child_${current_num}" multiple>
                                            <option value="">отсутствует</option>
                                            {% for p in Participants.query.filter_by(type=1).all() %}
                                                <option value="{{ p.participant_id }}">
                                                    {{ p.participant }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>`);
                            $(`#status_${current_num} option[value="${items['status']}"`).prop('selected', true);
                            for (let i of items['tax']) {
                                $(`#tax_${current_num}_${i}`).prop('checked', true);
                            };
                            for (let i of items['top']) {
                                $(`#top_${current_num}_${i}`).prop('checked', true);
                            };
                            for (let i of items['mer']) {
                                $(`#mer_${current_num}_${i}`).prop('checked', true);
                            };
                            for (let i of items['parents']) {
                                $(`#is_child_${current_num} option[value="${i}"`).prop('selected', true);
                            };
                            $(`#is_child_${current_num} option[value="${id}"`).prop('selected', true);
                        });
                    };
                });
            for (var i = 0; i < document.getElementsByTagName('textarea').length; ++i) {
            autosize(document.getElementsByTagName('textarea')[i]);
            }
        }

        function addElement(id) {
            if ($(`#${id}`).find('> div').length > 0) {
                var current_num = $(`#${id}`).find('> div').length + 1;
            } else {
                var current_num = 1
            }
            if (id == 'Implication') {
                var type = 'Impl';
                var assert_presuppose = ``
            } else {
                var type = Array.from(id)[0];
                var assert_presuppose =
            `
            <div class="col-auto">
                <select class="form-select form-select-sm" id="status_ese_${type}_${current_num}" name="status_ese_${type}_${current_num}">
                    <option value="1">ассерция</option>
                    <option value="2" selected>пресуппозиция</option>
                </select>
            </div>
            `
            }
            $(`#${id}`).append(
            `
            <div class="col row mb-1 align-items-center justify-content-start g-2 p-1" id="ese_column_${type}_${current_num}">
                <div class="col-3 col-xxl-2 g-2 mt-0 row align-items-center justify-content-center">
                    <div class="col-auto">
                        <span type="button" href="();" onclick="ese_column_${type}_${current_num}.remove()">❌</span>
                    </div>
                    <div class="col-auto">
                        <input class="form-control form-control-sm"
                               type="number" required
                               value="${current_num}"
                               id="rank_${type}_${current_num}"
                               name="rank_${type}_${current_num}"
                               >
                    </div>
                    ${assert_presuppose}
                </div>
                <div class="col-9 col-xxl-2">
                    <div class="form-floating">
                        <select class="form-select" id="is_child_${type}_${current_num}" name="is_child_${type}_${current_num}">
                            <option value="">нет</option>
                            {% for t in Templates.query.all() %}
                                <option value="{{t.templ_id}}">{{t.templ}}</option>
                            {% endfor %}
                        </select>
                        <label for="is_child_${type}_${current_num}">Родительский шаблон</label>
                    </div>
                </div>
                <div class="col-12 col-xxl-2">
                    <div class="form-floating">
                        <select class="form-select" id="control_${type}_${current_num}" name="control_${type}_${current_num}">
                            <option value="1">контролируемое</option>
                            <option value="2">неконтролируемое</option>
                            <option value="3">(не)контролируемое</option>
                        </select>
                        <label for="control_${type}_${current_num}">Контролируемость</label>
                    </div>
                </div>
                <div class="col-12 col-sm-12 col-xxl-6">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="${type}_${current_num}"
                               name="${type}_${current_num}"
                               placeholder="Введите текст"
                               list="${type}_list"
                               oninput="suggestions('${type}', ${type}_${current_num}.value)"
                        >
                        <label for="${type}_${current_num}">Введите описание</label>
                    </div>
                </div>
            </div>
            `
                );
            for (var i = 0; i < document.getElementsByTagName('textarea').length; ++i) {
            autosize(document.getElementsByTagName('textarea')[i]);
            }
        }

        function deleteParticipant(participant) {
            participant.remove()
        }

        function suggestions(type, input) {
            $(`#${type}_list`).empty();
            if (input.length > 2) {
                var packet = {
                    type: type,
                    input: input
                };
                fetch('{{ url_for('editing_autocomplete') }}', {
                    method: 'POST',
                    credentials: 'include',
                    body: JSON.stringify(packet),
                    cache: 'no-cache',
                    headers: new Headers({
                        'content-type': 'application/json'
                    })
                })
                .then(function (response) {
                    if (response.status == 200) {
                        response.json().then(function (items) {
                            for (var item in items) {
                                $(`#${type}_list`).append(
                                    `<option value="${items[item]}">`
                                )
                            }
                        })
                    }
                });
            }
        }

        $('#template').submit(function(event) {
            if ($('.is-invalid').length) {
                alert('Удостоверьтесь, что все ярлыки уникальны.')
                event.preventDefault();
                $('.is-invalid').focus();
            }
        });

        function addFromTemplate(id) {
            var packet = {
                    type: 'template_id',
                    input: id
                };
                fetch('{{ url_for('editing_autocomplete') }}', {
                    method: 'POST',
                    credentials: 'include',
                    body: JSON.stringify(packet),
                    cache: 'no-cache',
                    headers: new Headers({
                        'content-type': 'application/json'
                    })
                })
                .then(function (response) {
                    if (response.status == 200) {
                        response.json().then(function (items) {
                            for (let p of items['participants']) {
                                if ($('#participants').find('> div').length > 0) {
                                        var current_num = $('#participants').find('> div').length + 1;
                                    } else {
                                        var current_num = 1
                                    };
                                    $('#participants').append(
                                        `<div class="col row row-cols-1 align-items-center justify-content-center g-2 border-bottom border-1" id="participant_${current_num}">
                                            <div class="col-auto row align-items-center justify-content-center g-2">
                                                <div class="col-auto">
                                                    <button type="button" class="btn btn-sm btn-outline btn-outline-danger" onclick="deleteParticipant(participant_${current_num})">
                                                        Удалить
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col">
                                                <div class="form-floating">
                                                    <input type="text" class="form-control" id="label_${current_num}"
                                                           name="label_${current_num}"
                                                           placeholder="Введите текст"
                                                           value="${p['label']}"
                                                    >
                                                    <label for="label_${current_num}">Ярлык</label>
                                                </div>
                                            </div>
                                            <div class="col">
                                                <div class="form-floating">
                                                    <input type="text" class="form-control" id="sr_${current_num}"
                                                           name="sr_${current_num}"
                                                           placeholder="Введите текст"
                                                           list="sr_list"
                                                           value="${p['sr']}"
                                                           oninput="suggestions('sr', sr_${current_num}.value)"
                                                    >
                                                    <label for="sr_${current_num}">Семантическая роль</label>
                                                </div>
                                            </div>
                                            <div class="col">
                                                <div class="col-12 align-items-center text-center">
                                                    <span style="text-decoration-line: none; font-variant: small-caps">Мереология</span>
                                                </div>
                                                <div class="col-12 align-items-center text-center mb-1">
                                                    <a class="text-primary h5"
                                                       href="javascript:;"
                                                       role="button"
                                                       data-bs-toggle="dropdown"
                                                       data-bs-auto-close="outside"
                                                       aria-expanded="false"
                                                       style="text-decoration-line: none; font-size: smaller"
                                                       id="mer_ls_${current_num}"
                                                    >
                                                        ${p['mer_names']}
                                                    </a>
                                                    <ul class="dropdown-menu overflow-auto p-1" style="height: 200px">
                                                        {% for l in Labels.query.filter_by(type=1).order_by(Labels.rank.asc(), Labels.l.asc()).all() %}
                                                            <li>
                                                                <div class="form-check">
                                                                    <input class="form-check-input"
                                                                           type="checkbox"
                                                                           value="{{ l.l_id }}"
                                                                           id="mer_${current_num}_{{ l.l_id }}"
                                                                           name="mer_${current_num}_{{ l.l_id }}"
                                                                           full_name="{{ l.l }}"
                                                                           onclick="addLabels('mer_ls_${current_num}', 'mer_${current_num}_{{ l.l_id }}', 'Мереология')"
                                                                    >
                                                                    <label class="form-check-label"
                                                                           for="mer_${current_num}_{{ l.l_id }}"
                                                                           style="font-variant: small-caps"
                                                                    >
                                                                        {{ l.l }}
                                                                    </label>
                                                                </div>
                                                            </li>
                                                        {% endfor %}
                                                    </ul>
                                                </div>
                                                <div class="form-floating">
                                                    <input type="text" class="form-control" id="new_mer_${current_num}"
                                                           name="new_mer_${current_num}"
                                                           placeholder="Введите текст"
                                                    >
                                                    <label for="new_mer_${current_num}">Введите новые тэги через запятую</label>
                                                </div>
                                            </div>
                                            <div class="col">
                                                <div class="col-12 align-items-center text-center">
                                                    <span style="text-decoration-line: none; font-variant: small-caps">Таксономия</span>
                                                </div>
                                                <div class="col-12 align-items-center text-center mb-1">
                                                    <a class="text-primary h5"
                                                       href="javascript:;"
                                                       role="button"
                                                       data-bs-toggle="dropdown"
                                                       data-bs-auto-close="outside"
                                                       aria-expanded="false"
                                                       style="text-decoration-line: none; font-size: smaller"
                                                       id="tax_ls_${current_num}"
                                                    >
                                                        ${p['tax_names']}
                                                    </a>
                                                    <ul class="dropdown-menu overflow-auto p-1" style="height: 200px">
                                                        {% for l in Labels.query.filter_by(type=2).order_by(Labels.rank.asc(), Labels.l.asc()).all() %}
                                                            <li>
                                                                <div class="form-check">
                                                                    <input class="form-check-input"
                                                                           type="checkbox"
                                                                           value="{{ l.l_id }}"
                                                                           id="tax_${current_num}_{{ l.l_id }}"
                                                                           name="tax_${current_num}_{{ l.l_id }}"
                                                                           full_name="{{ l.l }}"
                                                                           onclick="addLabels('tax_ls_${current_num}', 'tax_${current_num}_{{ l.l_id }}', 'Таксономия')"
                                                                    >
                                                                    <label class="form-check-label"
                                                                           for="tax_${current_num}_{{ l.l_id }}"
                                                                           style="font-variant: small-caps"
                                                                    >
                                                                        {{ l.l }}
                                                                    </label>
                                                                </div>
                                                            </li>
                                                        {% endfor %}
                                                    </ul>
                                                </div>
                                                <div class="form-floating">
                                                    <input type="text" class="form-control" id="new_tax_${current_num}"
                                                           name="new_tax_${current_num}"
                                                           placeholder="Введите текст"
                                                    >
                                                    <label for="new_tax_${current_num}">Введите новые тэги через запятую</label>
                                                </div>
                                            </div>
                                            <div class="col">
                                                <div class="col-12 align-items-center text-center">
                                                    <span style="text-decoration-line: none; font-variant: small-caps">Топология</span>
                                                </div>
                                                <div class="col-12 align-items-center text-center mb-1">
                                                    <a class="text-primary h5"
                                                       href="javascript:;"
                                                       role="button"
                                                       data-bs-toggle="dropdown"
                                                       data-bs-auto-close="outside"
                                                       aria-expanded="false"
                                                       style="text-decoration-line: none; font-size: smaller"
                                                       id="top_ls_${current_num}"
                                                    >
                                                        ${p['top_names']}
                                                    </a>
                                                    <ul class="dropdown-menu overflow-auto p-1" style="height: 200px">
                                                        {% for l in Labels.query.filter_by(type=3).order_by(Labels.rank.asc(), Labels.l.asc()).all() %}
                                                            <li>
                                                                <div class="form-check">
                                                                    <input class="form-check-input"
                                                                           type="checkbox"
                                                                           value="{{ l.l_id }}"
                                                                           id="top_${current_num}_{{ l.l_id }}"
                                                                           name="top_${current_num}_{{ l.l_id }}"
                                                                           full_name="{{ l.l }}"
                                                                           onclick="addLabels('top_ls_${current_num}', 'top_${current_num}_{{ l.l_id }}', 'Топология')"
                                                                    >
                                                                    <label class="form-check-label"
                                                                           for="top_${current_num}_{{ l.l_id }}"
                                                                           style="font-variant: small-caps"
                                                                    >
                                                                        {{ l.l }}
                                                                    </label>
                                                                </div>
                                                            </li>
                                                        {% endfor %}
                                                    </ul>
                                                </div>
                                                <div class="form-floating">
                                                    <input type="text" class="form-control" id="new_top_${current_num}"
                                                           name="new_top_${current_num}"
                                                           placeholder="Введите текст"
                                                    >
                                                    <label for="new_top_${current_num}">Введите новые тэги через запятую</label>
                                                </div>
                                            </div>
                                            <div class="col">
                                                <div class="form-floating">
                                                    <input type="text" class="form-control" id="other_${current_num}"
                                                           name="other_${current_num}"
                                                           placeholder="Введите текст"
                                                           value="${p['other']}"
                                                    >
                                                    <label for="other_${current_num}">Другое</label>
                                                </div>
                                            </div>
                                            <div class="col">
                                                <div class="form-floating">
                                                    <select class="form-select" id="status_${current_num}" name="status_${current_num}">
                                                        <option selected value="1">ядерный</option>
                                                        <option value="2">периферийный</option>
                                                        <option value="3">инкорпорированный</option>
                                                    </select>
                                                    <label for="status_${current_num}">Этот участник</label>
                                                </div>
                                            </div>
                                            <div class="col mb-2">
                                                <div>
                                                    <label for="is_child_${current_num}" class="form-label">Родительский участник</label>
                                                    <select class="form-select" size="4" id="is_child_${current_num}" name="is_child_${current_num}" multiple>
                                                        <option value="">отсутствует</option>
                                                        {% for p in Participants.query.filter_by(type=1).all() %}
                                                            <option value="{{ p.participant_id }}">
                                                                {{ p.participant }}
                                                            </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>`);
                                    $(`#status_${current_num} option[value="${p['status']}"`).prop('selected', true);
                                    for (let i of p['mer']) {
                                        $(`#mer_${current_num}_${i}`).prop('checked', true);
                                    };
                                    for (let i of p['tax']) {
                                        $(`#tax_${current_num}_${i}`).prop('checked', true);
                                    };
                                    for (let i of p['top']) {
                                        $(`#top_${current_num}_${i}`).prop('checked', true);
                                    };
                                    for (let i of p['parents']) {
                                        $(`#is_child_${current_num} option[value="${i}"`).prop('selected', true);
                                    };
                                    $(`#is_child_${current_num} option[value="${p['id']}"`).prop('selected', true);
                                };
                            for (const e of items['ese']) {
                                for (let ee of e.slice(1)) {
                                    if ($(`#${e[0]}`).find('> div').length > 0) {
                                        var current_num = $(`#${e[0]}`).find('> div').length + 1;
                                    } else {
                                        var current_num = 1
                                    }
                                    if (e[0] == 'Implication') {
                                        var code = 'Impl';
                                    } else {
                                        var code = e[0][0];
                                    }
                                    addElement(e[0]);
                                    $(`#${code}_${current_num}`).val(ee[0])
                                    $(`#rank_${code}_${current_num}`).val(ee[2])
                                    $(`#is_child_${code}_${current_num} option[value="${ee[1]}"`).prop('selected', true);
                                    $(`#status_ese_${code}_${current_num} option[value="${ee[3]}"`).prop('selected', true);
                                }
                            };
                        });
                    }
                    $('#meaning').append(`<input class="d-none" type="number" name="based_on" value="${$('#based_on').val()}">`);
                    $("#based_on").prop('disabled', true)
                });
        }

        function addExample() {
            if ($(`#examples`).find('> div').length > 0) {
                var current_num = $(`#examples`).find('> div').length + 1;
            } else {
                var current_num = 1
            }
            $(`#examples`).append(
            `<div class="col" id="example_column_${current_num}">
                <div class="card my-2">
                    <div class="container my-2 text-danger text-center">
                        <span type="button" href="();" onclick="example_column_${current_num}.remove()">Удалить</span>
                    </div>
                    <div class="container my-2">
                        <div class="form-floating">
                            <textarea class="form-control overflow-auto"
                                      id="government_${current_num}"
                                      name="government_${current_num}"
                                      placeholder="Пример"
                                      style="max-height: 300px"></textarea>
                            <label for="government_${current_num}">Формула управления</label>
                        </div>
                    </div>
                    <div class="container mb-2">
                        <div class="form-floating">
                            <textarea class="form-control overflow-auto"
                                      id="example_${current_num}"
                                      name="example_${current_num}"
                                      placeholder="Пример"
                                      style="max-height: 300px"></textarea>
                            <label for="example_${current_num}">Пример (в транскрипции)</label>
                        </div>
                    </div>
                    <div class="container mb-2">
                        <div class="form-floating">
                            <textarea class="form-control overflow-auto"
                                      id="original_script_current_num"
                                      name="original_script_${current_num}"
                                      placeholder="Пример"
                                      style="max-height: 300px"></textarea>
                            <label for="original_script_${current_num}">В графике</label>
                        </div>
                    </div>
                    <div class="container mb-2">
                        <div class="form-floating">
                            <textarea class="form-control overflow-auto"
                                      id="translation_${current_num}"
                                      name="translation_${current_num}"
                                      placeholder="Пример"
                                      style="max-height: 300px"></textarea>
                            <label for="translation_${current_num}">Перевод</label>
                        </div>
                    </div>
                    <div class="container mb-2">
                        <div class="form-floating">
                            <textarea class="form-control overflow-auto"
                                      id="source_${current_num}"
                                      name="source_${current_num}"
                                      placeholder="Пример"
                                      style="max-height: 300px"></textarea>
                            <label for="source_${current_num}">Источник</label>
                        </div>
                    </div>
                </div>
            </div>`
                );
            $('#examples').children().last().attr("tabindex",-1).focus();
            for (var i = 0; i < document.getElementsByTagName('textarea').length; ++i) {
            autosize(document.getElementsByTagName('textarea')[i]);
            };
        }

        function addLabels(aim, dropdown, type) {
            if ($(`#${dropdown}`).is(':checked')) {
                const re_ns = RegExp('\n', 'g');
                const re_spaces = RegExp(' +$', 'gm');
                var current_text = $(`#${aim}`).text().replaceAll(re_ns, '').replace(re_spaces, '');
                if (current_text.match(type)) {
                    var selected = [$(`#${dropdown}`).attr('full_name')];
                } else {
                    var selected = [current_text, $(`#${dropdown}`).attr('full_name')];
                }
                $(`#${aim}`).text(selected.join(', '));
            } else {
                var label = $(`#${dropdown}`).attr('full_name');
                const re = RegExp(`(,)*( |^)${label}`.replace('\.', '\\\.'), 'g');
                const re_spaces = RegExp('[ \n]+$', 'gm');
                const re_beginning = RegExp('^[ \n]*, ', 'gm');
                var new_text = $(`#${aim}`).text().replace(re, '').replace(re_spaces, '');
                if (new_text == '') {
                    new_text = type
                }
                new_text = new_text.replace(re_beginning, '')
                $(`#${aim}`).text(new_text)
            }
        }
    </script>
{% endblock %}
